# GoReleaser é…ç½®æ–‡ä»¶
# æ–‡æ¡£: https://goreleaser.com/customization/
version: 2

# é¡¹ç›®åŸºæœ¬ä¿¡æ¯
project_name: qcc_plus

# ç¼–è¯‘å‰æ£€æŸ¥
before:
  hooks:
    # æ¸…ç†å¹¶ä¸‹è½½ä¾èµ–
    - go mod tidy
    - go mod download

# Go äºŒè¿›åˆ¶æ„å»ºé…ç½®
builds:
  - id: ccproxy
    # ä¸»ç¨‹åºå…¥å£
    main: ./cmd/cccli
    # äºŒè¿›åˆ¶æ–‡ä»¶å
    binary: ccproxy

    # ç¯å¢ƒå˜é‡
    env:
      - CGO_ENABLED=0

    # ç›®æ ‡å¹³å°
    goos:
      - linux
      - darwin
      - windows

    goarch:
      - amd64
      - arm64

    # å¿½ç•¥ç»„åˆï¼ˆmacOS æ²¡æœ‰ 386ï¼‰
    ignore:
      - goos: darwin
        goarch: "386"
      - goos: windows
        goarch: arm64

    # ç‰ˆæœ¬ä¿¡æ¯æ³¨å…¥ï¼ˆé€šè¿‡ ldflagsï¼‰
    ldflags:
      - -s -w
      - -X 'qcc_plus/internal/version.Version={{.Version}}'
      - -X 'qcc_plus/internal/version.GitCommit={{.ShortCommit}}'
      - -X 'qcc_plus/internal/version.BuildDate={{.Date}}'

# Docker é•œåƒæ„å»ºå’Œæ¨é€
dockers:
  - # Docker Hub é•œåƒ
    id: qcc_plus-amd64

    # ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ Dockerfile
    dockerfile: Dockerfile
    use: buildx

    # æ„å»ºå‚æ•°ï¼ˆä¸ç°æœ‰è„šæœ¬ä¿æŒä¸€è‡´ï¼‰
    build_flag_templates:
      - "--platform=linux/amd64"
      - "--build-arg=VERSION={{.Version}}"
      - "--build-arg=GIT_COMMIT={{.ShortCommit}}"
      - "--build-arg=BUILD_DATE={{.Date}}"
      - "--label=org.opencontainers.image.title={{.ProjectName}}"
      - "--label=org.opencontainers.image.description=Claude Code CLI å¤šç§Ÿæˆ·ä»£ç†æœåŠ¡å™¨"
      - "--label=org.opencontainers.image.version={{.Version}}"
      - "--label=org.opencontainers.image.created={{.Date}}"
      - "--label=org.opencontainers.image.source={{.GitURL}}"
      - "--label=org.opencontainers.image.revision={{.FullCommit}}"

    # é•œåƒæ ‡ç­¾
    image_templates:
      - "yxhpy520/{{.ProjectName}}:{{.Version}}-amd64"
      - "yxhpy520/{{.ProjectName}}:latest-amd64"

  - # ARM64 é•œåƒ
    id: qcc_plus-arm64
    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/arm64"
      - "--build-arg=VERSION={{.Version}}"
      - "--build-arg=GIT_COMMIT={{.ShortCommit}}"
      - "--build-arg=BUILD_DATE={{.Date}}"
      - "--label=org.opencontainers.image.title={{.ProjectName}}"
      - "--label=org.opencontainers.image.description=Claude Code CLI å¤šç§Ÿæˆ·ä»£ç†æœåŠ¡å™¨"
      - "--label=org.opencontainers.image.version={{.Version}}"
      - "--label=org.opencontainers.image.created={{.Date}}"
      - "--label=org.opencontainers.image.source={{.GitURL}}"
      - "--label=org.opencontainers.image.revision={{.FullCommit}}"

    image_templates:
      - "yxhpy520/{{.ProjectName}}:{{.Version}}-arm64"
      - "yxhpy520/{{.ProjectName}}:latest-arm64"

    goarch: arm64

# Docker Manifestï¼ˆå¤šæ¶æ„é•œåƒæ”¯æŒï¼‰
docker_manifests:
  - # ç‰ˆæœ¬æ ‡ç­¾çš„ manifest
    name_template: "yxhpy520/{{.ProjectName}}:{{.Version}}"
    image_templates:
      - "yxhpy520/{{.ProjectName}}:{{.Version}}-amd64"
      - "yxhpy520/{{.ProjectName}}:{{.Version}}-arm64"

  - # latest æ ‡ç­¾çš„ manifest
    name_template: "yxhpy520/{{.ProjectName}}:latest"
    image_templates:
      - "yxhpy520/{{.ProjectName}}:latest-amd64"
      - "yxhpy520/{{.ProjectName}}:latest-arm64"

# å½’æ¡£é…ç½®ï¼ˆå‘å¸ƒçš„å‹ç¼©åŒ…ï¼‰
archives:
  - id: default
    # å½’æ¡£æ–‡ä»¶åæ¨¡æ¿
    name_template: >-
      {{ .ProjectName }}_
      {{- .Version }}_
      {{- .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}

    # åŒ…å«çš„æ–‡ä»¶
    files:
      - README.md
      - LICENSE
      - CHANGELOG.md
      - docs/**/*

# Checksum æ–‡ä»¶
checksum:
  name_template: 'checksums.txt'

# Snapshot ç‰ˆæœ¬é…ç½®ï¼ˆç”¨äºæµ‹è¯•ï¼‰
snapshot:
  version_template: "{{ incpatch .Version }}-next"

# CHANGELOG è‡ªåŠ¨ç”Ÿæˆ
changelog:
  sort: asc
  use: github

  # Changelog åˆ†ç»„
  groups:
    - title: 'ğŸš€ æ–°åŠŸèƒ½'
      regexp: "^.*feat[(\\w)]*:+.*$"
      order: 0
    - title: 'ğŸ› Bug ä¿®å¤'
      regexp: "^.*fix[(\\w)]*:+.*$"
      order: 1
    - title: 'ğŸ“ æ–‡æ¡£æ›´æ–°'
      regexp: "^.*docs[(\\w)]*:+.*$"
      order: 2
    - title: 'ğŸ”¨ é‡æ„'
      regexp: "^.*refactor[(\\w)]*:+.*$"
      order: 3
    - title: 'ğŸ§ª æµ‹è¯•'
      regexp: "^.*test[(\\w)]*:+.*$"
      order: 4
    - title: 'ğŸ”§ å…¶ä»–'
      order: 999

  # è¿‡æ»¤è§„åˆ™ï¼ˆä¸åŒ…å«åœ¨ changelog ä¸­çš„æäº¤ï¼‰
  filters:
    exclude:
      - '^chore:'
      - '^ci:'
      - '^build:'
      - '^style:'
      - 'merge conflict'
      - Merge pull request
      - Merge remote-tracking branch
      - Merge branch

# GitHub Release é…ç½®
release:
  # GitHub ä»“åº“ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
  github:
    owner: yxhpy
    name: qcc_plus

  # Release åç§°æ¨¡æ¿
  name_template: "{{.ProjectName}} {{.Version}}"

  # æ˜¯å¦ä¸ºè‰ç¨¿
  draft: false

  # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆæ ¹æ®ç‰ˆæœ¬å·è‡ªåŠ¨åˆ¤æ–­ï¼‰
  prerelease: auto

  # Release è¯´æ˜æ¨¡æ¿
  header: |
    ## qcc_plus {{.Version}}

    **å‘å¸ƒæ—¥æœŸ**: {{.Date}}

    ## ğŸ“¦ å®‰è£…æ–¹å¼

    ### Docker éƒ¨ç½²ï¼ˆæ¨èï¼‰
    ```bash
    # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
    docker pull yxhpy520/qcc_plus:{{.Version}}

    # ä½¿ç”¨ docker-compose
    docker compose up -d
    ```

    ### äºŒè¿›åˆ¶å®‰è£…
    ä»ä¸‹æ–¹ Assets ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…ï¼Œè§£å‹åå³å¯ä½¿ç”¨ã€‚

    ### ä»æºç æ„å»º
    ```bash
    git clone -b {{.Version}} https://github.com/yxhpy/qcc_plus.git
    cd qcc_plus
    go build -o ccproxy ./cmd/cccli
    ```

  footer: |
    ---

    **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/yxhpy/qcc_plus/blob/main/CHANGELOG.md

    **æ–‡æ¡£**: https://github.com/yxhpy/qcc_plus#readme

    **é—®é¢˜åé¦ˆ**: https://github.com/yxhpy/qcc_plus/issues

# å‘å¸ƒå…¬å‘Šï¼ˆå¯é€‰ï¼Œç”¨äºå…¶ä»–å¹³å°ï¼‰
announce:
  skip: true

# é€šç”¨é…ç½®
dist: dist
