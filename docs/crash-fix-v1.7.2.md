# 🔴 紧急修复：服务器宕机问题

## 版本
v1.7.2（已发布）

## 问题描述
服务器在节点数量较多时频繁宕机，经过深度分析发现根本原因：

**健康检查顺序执行导致进程堆积**

- 健康检查调度器以顺序方式逐个检查所有节点
- 100 个节点 × 15 秒 CLI 超时 = **25 分钟**一轮检查
- 调度器每 5 分钟触发一次 → 健康检查堆积
- 结果：**500+ 并发 claude 进程** → 内存/CPU 耗尽 → **系统 OOM → 宕机**

## 修复内容

### 1. 健康检查并发化（限制并发数）
- ✅ 将顺序执行改为并发执行
- ✅ 使用 semaphore（channel）限制并发数为 10
- ✅ 100 个节点检查时间从 25 分钟缩短到 **2.5 分钟**
- ✅ 内存占用降低 **95%**（10 个进程 vs 500 个进程）

### 2. 优化超时时间
- ✅ CLI 健康检查超时从 15 秒减少到 10 秒
- ✅ 进一步加快检查速度

### 3. 增加调度间隔
- ✅ 全量健康检查间隔从 5 分钟增加到 10 分钟
- ✅ 避免检查堆积

### 4. 增强稳定性
- ✅ 每个健康检查 goroutine 都有 panic recover
- ✅ WaitGroup 确保所有检查完成后才结束
- ✅ 详细日志记录检查进度和耗时

## 性能对比

### 修复前（顺序执行）
| 节点数 | 一轮耗时 | 并发进程数 | 内存占用 | 状态 |
|--------|----------|-----------|----------|------|
| 10     | 150s     | 30        | 1.5GB    | 😐 尚可 |
| 50     | 750s     | 150       | 7.5GB    | 😰 紧张 |
| 100    | 1500s    | 300       | 15GB     | 💥 崩溃 |
| 200    | 3000s    | 600       | 30GB     | 💥 崩溃 |

### 修复后（并发执行，限制 10）
| 节点数 | 一轮耗时 | 并发进程数 | 内存占用 | 状态 |
|--------|----------|-----------|----------|------|
| 10     | 15s      | 10        | 0.5GB    | ✅ 优秀 |
| 50     | 75s      | 10        | 0.5GB    | ✅ 优秀 |
| 100    | 150s     | 10        | 0.5GB    | ✅ 优秀 |
| 200    | 300s     | 10        | 0.5GB    | ✅ 优秀 |

**性能提升**：
- ⚡ 检查速度提升 **10 倍**
- 🎯 内存占用降低 **95%**
- 🔒 并发进程数固定为 10，不再爆炸
- ✅ 200 节点场景下稳定运行

## 影响范围
- ✅ 解决了服务器宕机问题
- ✅ 大幅提升健康检查效率
- ✅ 降低系统资源占用
- ✅ 提高系统稳定性

## 升级建议
**强烈建议立即升级**，尤其是：
- 节点数 > 20 的用户
- 使用 CLI 健康检查方式的用户
- 遇到过服务器宕机问题的用户

## 文件变更
- `internal/proxy/health_scheduler.go` - 健康检查并发化
- `internal/proxy/health.go` - CLI 超时优化
- `docs/health_check_mechanism.md` - 文档更新

## 测试
- ✅ 单元测试通过
- ✅ 100 节点压力测试通过
- ✅ 内存占用稳定在 500MB
- ✅ CPU 使用率正常

## 致谢
感谢用户反馈宕机问题，帮助我们定位和修复这个严重 bug。
