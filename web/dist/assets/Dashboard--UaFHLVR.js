import{r as o,j as e,d as X,D as Y}from"./vendor-HVpYYIdB.js";import{C as Z,a as ee,L as se,b as te,A as ae,p as re,c as le}from"./charts-USIkmnH5.js";import{C as B}from"./Card-Bmh2bB8_.js";import{T as ne}from"./Toast-BukLN0_W.js";import{b as ce,c as U}from"./index-B2aCquF1.js";import{f as oe}from"./date-DeDlRUHn.js";function j(a){return getComputedStyle(document.documentElement).getPropertyValue(a).trim()}function C(a,l){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(!r)return a;const m=parseInt(r[1],16),c=parseInt(r[2],16),N=parseInt(r[3],16);return`rgba(${m}, ${c}, ${N}, ${l})`}function ie(){const{resolvedTheme:a}=ce(),[,l]=o.useState(0);return o.useEffect(()=>{l(r=>r+1)},[a]),o.useMemo(()=>{const r=a==="dark",m=j("--color-success-500")||"#12B76A",c=j("--color-warning-500")||"#F59E0B",N=j("--color-danger-500")||"#EF4444",d=j("--color-info-500")||"#3B82F6",y=j("--color-primary-500")||"#3B82F6",F=j("--color-text-primary")||(r?"#F8FAFC":"#0F172A"),$=j("--color-text-secondary")||(r?"#CBD5E1":"#334155"),k=j("--color-text-muted")||"#64748B",q=j("--color-border-default")||(r?"#334155":"#CBD5E1");return{success:m,successBg:C(m,.12),warning:c,warningBg:C(c,.12),danger:N,dangerBg:C(N,.12),info:d,infoBg:C(d,.12),textPrimary:F,textSecondary:$,textMuted:k,gridColor:C(r?"#FFFFFF":"#000000",r?.08:.06),borderColor:q,palette:[y,m,c,"#A855F7","#06B6D4",k]}},[a])}Z.register(ee,se,te,ae,re,le);function de(a){const l=Number(a||0);if(!l)return"-";const r=["B","KB","MB","GB","TB"];let m=0,c=l;for(;c>=1024&&m<r.length-1;)c/=1024,m++;const N=c>=10?1:2;return`${c.toFixed(N)} ${r[m]}`}function V(a){const l=Number(a||0);return l>=1e9?`${(l/1e9).toFixed(1)}B`:l>=1e6?`${(l/1e6).toFixed(1)}M`:l>=1e3?`${(l/1e3).toFixed(1)}K`:l.toLocaleString("en-US")}function ue(a){const l=Number(a.requests||0),r=Number(a.fail_count||0);return l<=0?100:Math.max(0,(l-r)/l*100)}function A(a){const l=Number(a.total_bytes||0),r=Number(a.stream_dur_ms||0);return l<=0||r<=0?0:l/(r/1e3)}function R(a){return a<=0?"-":a>=1e6?`${(a/1e6).toFixed(1)} MB/s`:a>=1e3?`${(a/1e3).toFixed(1)} KB/s`:`${a.toFixed(0)} B/s`}function he(a){return a.disabled?"off":a.failed||Number(a.fail_streak||0)>3?"fail":Number(a.fail_streak||0)>0?"warn":"ok"}function Ne(){const[a,l]=o.useState([]),[r,m]=o.useState(""),[c,N]=o.useState([]),[d,y]=o.useState(!0),[F,$]=o.useState(null),[k,q]=o.useState(!0),[D,W]=o.useState(null),b=ie(),w=(s,t="success")=>{$({message:s,type:t}),setTimeout(()=>$(null),2200)},S=o.useCallback(async(s=!0)=>{if(r){s&&y(!0);try{const t=await U.getNodes(r);N(t),W(new Date)}catch(t){w(t.message||"åŠ è½½å¤±è´¥","error")}finally{y(!1)}}},[r]),I=o.useCallback(async()=>{y(!0);try{const s=await U.getAccounts();l(s),m(t=>t||(s[0]?.id??""))}catch{w("åŠ è½½è´¦å·å¤±è´¥","error")}finally{y(!1)}},[]);o.useEffect(()=>{I()},[I]),o.useEffect(()=>{r&&S()},[r,S]),o.useEffect(()=>{if(!k||!r)return;const s=setInterval(()=>S(!1),6e3);return()=>clearInterval(s)},[k,r,S]);const i=o.useMemo(()=>{let s=0,t=0,x=0,g=0,u=0,n=0,f=0;c.forEach(p=>{const T=Number(p.requests||0),M=Number(p.fail_count||0);s+=T,t+=M,!p.disabled&&!p.failed&&(x+=1);const _=A(p);_>0&&(n+=_,f+=1),g+=Number(p.total_bytes||0),u+=Number(p.input_tokens||0)+Number(p.output_tokens||0)});const L=s>0?(s-t)/s*100:100,h=f>0?n/f:0,v=s>0?t/s*100:0;return{totalReq:s,totalFail:t,active:x,totalBytes:g,totalTokens:u,avgThroughput:h,successRate:L,failRate:v,throughputCount:f}},[c]),E=o.useMemo(()=>{const s=[];return c.forEach(t=>{const x=A(t);t.failed&&s.push({type:"failed",node:t.name||"æœªå‘½å",message:t.last_error||"æœªçŸ¥åŸå› ",raw:t.last_error}),Number(t.fail_streak||0)>3&&s.push({type:"streak",node:t.name||"æœªå‘½å",message:`è¿ç»­å¤±è´¥ ${t.fail_streak} æ¬¡`}),x>0&&x<1e4&&s.push({type:"slow",node:t.name||"æœªå‘½å",message:`è¾“å‡ºé€Ÿç‡è¿‡ä½ï¼ˆ${R(x)}ï¼‰`})}),s},[c]),z=E.slice(0,3),K=o.useMemo(()=>{const s=n=>n>=5e4?b.success:n>=1e4?b.warning:b.danger,t=c.map(n=>({label:n.name||"æœªå‘½å",value:A(n)})).sort((n,f)=>f.value-n.value),x=t.length?t.map(n=>n.label):["æš‚æ— æ•°æ®"],g=t.length?t.map(n=>n.value):[0],u=g.map(n=>s(n));return{data:{labels:x,datasets:[{data:g,backgroundColor:u,borderRadius:6}]},options:{indexAxis:"y",scales:{x:{grid:{color:b.gridColor},title:{display:!0,text:"å­—èŠ‚/ç§’"}},y:{ticks:{color:b.textSecondary}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label(n){return R(Number(n.raw))}}}},maintainAspectRatio:!1}}},[c,b]),P=o.useMemo(()=>{const s=c.slice().sort((h,v)=>Number(v.requests||0)-Number(h.requests||0)),t=s.slice(0,5),x=s.slice(5),g=t.map(h=>Number(h.requests||0)),u=t.map(h=>h.name||"æœªå‘½å"),n=x.reduce((h,v)=>h+Number(v.requests||0),0);n>0&&(g.push(n),u.push("å…¶ä»–")),g.length||(g.push(0),u.push("æš‚æ— æ•°æ®"));const f=b.palette,L=u.map((h,v)=>f[v%f.length]);return{data:{labels:u,datasets:[{data:g,backgroundColor:L,borderWidth:1}]},options:{plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label(h){const p=(h.dataset.data||[]).reduce((_,Q)=>_+Number(Q),0)||1,T=Number(h.raw),M=(T/p*100).toFixed(1);return`${h.label}: ${T.toLocaleString("en-US")} (${M}%)`}}}},maintainAspectRatio:!1}}},[c,b]),G=async s=>{try{await U.activateNode(s),w("å·²è®¾ä¸ºæ´»è·ƒ"),S(!1)}catch(t){w(t.message||"åˆ‡æ¢å¤±è´¥","error")}},H=i.successRate<90?"warn":"green",J=i.failRate>5?"warn":"gray",O=i.avgThroughput>=5e4?"green":i.avgThroughput>=1e4?"gray":"warn";return e.jsxs("div",{children:[e.jsx("h1",{children:"ä»ªè¡¨ç›˜"}),e.jsx("p",{className:"sub",children:"å…¨æ™¯æ´å¯ŸèŠ‚ç‚¹å¥åº·ã€æµé‡ä¸æ€§èƒ½ï¼Œæ”¯æŒ 6 ç§’è‡ªåŠ¨åˆ·æ–°ã€‚"}),e.jsxs(B,{children:[e.jsxs("div",{className:"toolbar",children:[e.jsxs("label",{style:{minWidth:220},children:["é€‰æ‹©è´¦å·",e.jsx("select",{value:r,onChange:s=>m(s.target.value),children:a.map(s=>e.jsxs("option",{value:s.id,children:[s.name,s.is_admin?" [ç®¡ç†å‘˜]":""]},s.id))})]}),e.jsx("div",{className:"spacer"}),e.jsxs("label",{className:"auto-refresh",children:[e.jsx("input",{type:"checkbox",checked:k,onChange:s=>q(s.target.checked)}),"è‡ªåŠ¨åˆ·æ–° 6s"]}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>S(),disabled:d,children:"ç«‹å³åˆ·æ–°"})]}),e.jsxs("div",{className:"kpi-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"muted-title",children:"æ€»è¯·æ±‚æ•°"}),e.jsx("div",{className:`kpi-main ${d?"skeleton":""}`,children:i.totalReq.toLocaleString("en-US")}),e.jsxs("div",{className:`badge ${H}`,children:["æˆåŠŸç‡ ",i.successRate.toFixed(1),"%"]}),e.jsxs("small",{className:"muted",children:["å¤±è´¥ ",i.totalFail.toLocaleString("en-US")," (",i.failRate.toFixed(1),"%)"]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"muted-title",children:"æ´»è·ƒèŠ‚ç‚¹æ•°"}),e.jsxs("div",{className:`kpi-main ${d?"skeleton":""}`,children:[i.active," / ",c.length]}),e.jsx("div",{className:"badge gray",children:"è¿è¡Œä¸­"}),e.jsx("small",{className:"muted",children:"æ´»è·ƒ / æ€»æ•°"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"muted-title",children:"å¹³å‡è¾“å‡ºé€Ÿç‡"}),e.jsx("div",{className:`kpi-main ${d?"skeleton":""}`,children:R(i.avgThroughput)}),e.jsx("div",{className:`badge ${O}`,children:"è¾“å‡ºé€Ÿç‡"}),e.jsx("small",{className:"muted",children:i.throughputCount>0?`åŸºäº ${i.throughputCount} ä¸ªèŠ‚ç‚¹`:"ç­‰å¾…æ›´å¤šæ•°æ®"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"muted-title",children:"Token æ¶ˆè€—"}),e.jsx("div",{className:`kpi-main ${d?"skeleton":""}`,children:V(i.totalTokens)}),e.jsx("div",{className:"badge warn",children:"è¾“å…¥ + è¾“å‡º"}),e.jsx("small",{className:"muted",children:"ç´¯è®¡ Tokens"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"muted-title",children:"æ€»æµé‡"}),e.jsx("div",{className:`kpi-main ${d?"skeleton":""}`,children:de(i.totalBytes)}),e.jsx("div",{className:"badge gray",children:"å¸¦å®½"}),e.jsx("small",{className:"muted",children:"ç´¯è®¡å­—èŠ‚"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"muted-title",children:"å¤±è´¥è¯·æ±‚æ•°"}),e.jsx("div",{className:`kpi-main ${d?"skeleton":""}`,children:i.totalFail.toLocaleString("en-US")}),e.jsxs("div",{className:`badge ${J}`,children:["å¤±è´¥ç‡ ",i.failRate.toFixed(1),"%"]}),e.jsx("small",{className:"muted",children:"å¤±è´¥æ¬¡æ•° / è¯·æ±‚æ•°"})]})]})]}),e.jsx(B,{title:"èŠ‚ç‚¹æ€§èƒ½ä¸è¯·æ±‚åˆ†å¸ƒ",extra:e.jsx("div",{className:"badge gray",children:D?`æ›´æ–°äº ${oe(D)}`:"--"}),children:e.jsxs("div",{className:"chart-grid",children:[e.jsx(B,{className:"chart-card",title:"èŠ‚ç‚¹æ€§èƒ½å¯¹æ¯”",extra:e.jsx("div",{className:"chart-legend",children:"ğŸŸ¢ >50KB/s Â· ğŸŸ¡ 10-50KB/s Â· ğŸ”´ <10KB/s"}),children:e.jsx("div",{className:d?"chart-skeleton":"chart-body",children:d?e.jsx("div",{className:"skeleton",style:{height:14}}):e.jsx(X,{data:K.data,options:K.options})})}),e.jsx(B,{className:"chart-card",title:"èŠ‚ç‚¹è¯·æ±‚åˆ†å¸ƒ",extra:e.jsxs("div",{className:"badge gray",children:["æ€»è¯·æ±‚ ",i.totalReq.toLocaleString("en-US")]}),children:e.jsx("div",{className:d?"chart-skeleton":"chart-body",children:d?e.jsx("div",{className:"skeleton",style:{height:14}}):e.jsx(Y,{data:P.data,options:P.options})})})]})}),E.length>0&&e.jsx(B,{title:"å‘Šè­¦",extra:e.jsx("span",{className:"pill-small",style:{background:"#fee2e2",color:"#b91c1c"},children:E.length}),children:e.jsx("div",{className:"alert-list",children:z.map((s,t)=>e.jsxs("div",{className:"alert-card",children:[e.jsxs("div",{className:"alert-title",children:[e.jsx("strong",{children:s.node}),": ",s.message]}),s.type==="failed"&&s.raw&&String(s.raw).length>50&&e.jsxs("details",{children:[e.jsx("summary",{children:"æŸ¥çœ‹å®Œæ•´é”™è¯¯"}),e.jsx("pre",{children:s.raw})]})]},t))})}),e.jsx(B,{title:"èŠ‚ç‚¹å¥åº·åˆ—è¡¨",extra:e.jsx("small",{className:"muted",children:"æŒ‰è¯·æ±‚æ•°æ’åºï¼ŒæˆåŠŸç‡ä½äº 90% æ ‡çº¢ã€‚"}),children:e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"health-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"èŠ‚ç‚¹å"}),e.jsx("th",{children:"çŠ¶æ€"}),e.jsx("th",{children:"è¯·æ±‚æ•°"}),e.jsx("th",{children:"æˆåŠŸç‡"}),e.jsx("th",{children:"è¾“å‡ºé€Ÿç‡"}),e.jsx("th",{children:"Tokens"}),e.jsx("th",{children:"æ“ä½œ"})]})}),e.jsx("tbody",{children:d?e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:e.jsx("div",{className:"skeleton",style:{height:18}})})}):c.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"æš‚æ— èŠ‚ç‚¹"})}):c.slice().sort((s,t)=>Number(t.requests||0)-Number(s.requests||0)).map(s=>{const t=ue(s),x=A(s),g=Number(s.input_tokens||0)+Number(s.output_tokens||0),u=he(s),n=u==="ok"?"æ­£å¸¸":u==="fail"?"å¤±è´¥":u==="off"?"å·²ç¦ç”¨":"è­¦å‘Š";return e.jsxs("tr",{children:[e.jsxs("td",{children:[s.name||"æœªå‘½å",e.jsxs("div",{className:"muted",style:{fontSize:12},children:["æƒé‡ ",s.weight||1]})]}),e.jsx("td",{children:e.jsx("span",{className:`tag ${u}`,children:n})}),e.jsx("td",{children:Number(s.requests||0).toLocaleString("en-US")}),e.jsx("td",{children:e.jsxs("span",{className:t<90?"danger-text":"",children:[t.toFixed(1),"%"]})}),e.jsx("td",{children:R(x)}),e.jsx("td",{children:V(g)}),e.jsx("td",{children:e.jsx("div",{className:"table-actions",children:e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>G(s.id),disabled:s.disabled,children:"è®¾ä¸ºæ´»è·ƒ"})})})]},s.id)})})]})})}),e.jsx(ne,{message:F?.message,type:F?.type})]})}export{Ne as default};
