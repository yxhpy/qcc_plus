import{l as xe,r as a,j as e}from"./vendor-HVpYYIdB.js";import{C as k}from"./Card-Bmh2bB8_.js";import{u as pe,N as ge}from"./useMonitorWebSocket-BPhPhOjT.js";import{T as je}from"./Toast-BukLN0_W.js";import{u as _e,d as ve,e as Ne,c as g}from"./index-JckuGpfa.js";import{p as M,f as O}from"./date-DeDlRUHn.js";import"./charts-USIkmnH5.js";function Te({shared:n=!1}){const Q=xe(),o=n?Q.token:void 0,{isAdmin:j}=_e(),{preference:I,setPreference:A,resetToDefault:V}=ve(),{getSetting:X}=Ne(),y=X("monitor.refresh_interval_ms",3e4),[Y,Z]=a.useState([]),[i,$]=a.useState(""),[d,D]=a.useState(null),[S,_]=a.useState(!0),[L,H]=a.useState(!1),[w,ee]=a.useState(!0),[P,U]=a.useState(null),[W,K]=a.useState([]),[C,v]=a.useState(!1),[B,se]=a.useState("24h"),[te,ae]=a.useState(0),[re,F]=a.useState({}),z=a.useRef(""),ne=n?void 0:i||void 0,{connected:G,lastMessage:x}=pe(ne,o),h=(s,t="success")=>{U({message:s,type:t}),setTimeout(()=>U(null),2200)},J=a.useCallback(async()=>{_(!0);try{const s=await g.getAccounts();Z(s),$(t=>t||(s[0]?.id??""))}catch{h("åŠ è½½è´¦å·å¤±è´¥","error")}finally{_(!1)}},[]),p=a.useCallback(async(s=!0)=>{if(!(n&&!o)&&!(!n&&!i)){s&&_(!0),H(!0);try{const t=n&&o?await g.getSharedMonitor(o):await g.getMonitorDashboard(i),l=(t.nodes||[]).map(u=>u.id).sort().join("|"),r=`${n?"shared":i||"default"}|${o||""}|${l}`;D(t),ae(u=>r!==z.current?(z.current=r,u+1):u)}catch(t){h(t.message||"åŠ è½½å¤±è´¥","error")}finally{_(!1),H(!1)}}},[i,o,n]),R=a.useCallback(async()=>{if(!(n||!j||!i)){v(!0);try{const s=await g.getMonitorShares(i);K(s.shares||[])}catch{h("åŠ è½½åˆ†äº«åˆ—è¡¨å¤±è´¥","error")}finally{v(!1)}}},[i,j,n]);a.useEffect(()=>{n||J()},[J,n]),a.useEffect(()=>{n?o&&p():i&&p()},[i,p,n,o]),a.useEffect(()=>{if(!w)return;const s=setInterval(()=>p(!1),y);return()=>clearInterval(s)},[w,p,y]),a.useEffect(()=>{R()},[R]),a.useEffect(()=>{F({})},[i,o]),a.useEffect(()=>{if(!x)return;if(x.type==="health_check"){const t=x.payload;F(l=>({...l,[t.node_id]:{node_id:t.node_id,check_time:t.check_time,success:t.success,response_time_ms:t.response_time_ms??0,error_message:t.error_message||"",check_method:t.check_method||"api"}}));return}if(x.type!=="node_status"&&x.type!=="node_metrics")return;const s=x.payload;D(t=>{if(!t)return t;const l=t.nodes.findIndex(q=>q.id===s.node_id);if(l===-1)return t;const r=t.nodes[l],u={success_rate:s.traffic?.success_rate??s.success_rate??r.traffic?.success_rate??0,avg_response_time:s.traffic?.avg_response_time??s.avg_response_time??r.traffic?.avg_response_time??0,total_requests:s.traffic?.total_requests??s.total_requests??r.traffic?.total_requests??0,failed_requests:s.traffic?.failed_requests??s.failed_requests??r.traffic?.failed_requests??0},N={status:s.health?.status??r.health?.status??"up",last_check_at:s.health?.last_check_at??s.timestamp??r.health?.last_check_at??null,last_ping_ms:s.health?.last_ping_ms??s.last_ping_ms??r.health?.last_ping_ms??0,last_ping_err:s.health?.last_ping_err??r.health?.last_ping_err??"",check_method:(s.health?.check_method??r.health?.check_method??"api").toLowerCase()},b={...r,status:s.status||r.status,is_active:s.active!==void 0?s.active:r.is_active,last_error:s.error??r.last_error,traffic:u,health:N},T=s.traffic?.success_rate!==void 0||s.success_rate!==void 0,c=s.timestamp||N.last_check_at||void 0;if(T&&c){const q=(r.trend_24h||[]).filter(E=>E.timestamp!==c).concat({timestamp:c,success_rate:u.success_rate,avg_time:u.avg_response_time}).sort((E,me)=>{const ue=M(E.timestamp)?.getTime()||0,fe=M(me.timestamp)?.getTime()||0;return ue-fe}).slice(-96);b.trend_24h=q}const f=t.nodes.slice();return f[l]=b,{...t,nodes:f,updated_at:c||t.updated_at}})},[x]);const m=a.useMemo(()=>{const s=d?.nodes||[],t=s.reduce((c,f)=>c+Number(f.traffic?.total_requests||0),0),l=s.reduce((c,f)=>c+Number(f.traffic?.failed_requests||0),0),r=t>0?(t-l)/t*100:100,u=s.length>0?s.reduce((c,f)=>c+Number(f.traffic?.avg_response_time||0),0)/s.length:0,N=s.filter(c=>c.status==="online").length,b=s.filter(c=>c.status==="offline"||c.status==="degraded").length,T=s.filter(c=>c.status==="disabled").length;return{totalRequests:t,failedRequests:l,successRate:r,avgResponse:u,online:N,offline:b,disabled:T}},[d]),ce=async()=>{if(!i){h("è¯·é€‰æ‹©è´¦å·","error");return}v(!0);try{const s=await g.createMonitorShare({account_id:i,expire_in:B});K(t=>[s,...t]),h("å·²ç”Ÿæˆåˆ†äº«é“¾æ¥")}catch(s){h(s.message||"åˆ›å»ºå¤±è´¥","error")}finally{v(!1)}},ie=async s=>{try{await g.revokeMonitorShare(s),h("å·²æ’¤é”€"),R()}catch(t){h(t.message||"æ’¤é”€å¤±è´¥","error")}},le=async s=>{try{await navigator.clipboard.writeText(s),h("å·²å¤åˆ¶é“¾æ¥")}catch{h("å¤åˆ¶å¤±è´¥","error")}},oe=s=>s.share_url||`${window.location.origin}/monitor/share/${s.token}`,de=n?"å…±äº«ç›‘æ§å¤§å±":"ç›‘æ§å¤§å±",he=n?"åªè¯»æ¨¡å¼ Â· é€šè¿‡åˆ†äº«é“¾æ¥æŸ¥çœ‹å®æ—¶çŠ¶æ€":"å®æ—¶æ´å¯ŸèŠ‚ç‚¹çŠ¶æ€ä¸ 24 å°æ—¶è¶‹åŠ¿";return e.jsxs("div",{className:"monitor-page",children:[e.jsxs("div",{className:"monitor-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:de}),e.jsx("p",{className:"sub",children:he})]}),e.jsxs("div",{className:"monitor-header-actions",children:[e.jsxs("div",{className:`ws-pill ${G?"on":"off"}`,children:[e.jsx("span",{className:"status-dot"}),"WebSocket ",G?"å·²è¿æ¥":"æœªè¿æ¥"]}),e.jsxs("div",{className:"monitor-settings",children:[e.jsxs("label",{className:"setting-toggle",children:[e.jsx("span",{children:"ä»£ç†"}),e.jsxs("span",{className:"toggle-mini",children:[e.jsx("input",{type:"checkbox",checked:I.showProxy,onChange:s=>A({showProxy:s.target.checked})}),e.jsx("span",{className:"slider"})]})]}),e.jsxs("label",{className:"setting-toggle",children:[e.jsx("span",{children:"æ¢æ´»"}),e.jsxs("span",{className:"toggle-mini",children:[e.jsx("input",{type:"checkbox",checked:I.showHealth,onChange:s=>A({showHealth:s.target.checked})}),e.jsx("span",{className:"slider"})]})]}),e.jsx("button",{className:"reset-btn",onClick:V,children:"é‡ç½®"})]}),!n&&e.jsxs("label",{className:"auto-refresh",children:[e.jsxs("span",{className:"toggle-mini",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:s=>ee(s.target.checked)}),e.jsx("span",{className:"slider"})]}),"è‡ªåŠ¨åˆ·æ–° ",Math.round(y/1e3),"s"]}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>p(),disabled:L,children:L?"åˆ·æ–°ä¸­...":"ç«‹å³åˆ·æ–°"})]})]}),!n&&e.jsx(k,{children:e.jsxs("div",{className:"monitor-toolbar",children:[j&&e.jsxs("label",{children:["é€‰æ‹©è´¦å·",e.jsx("select",{value:i,onChange:s=>$(s.target.value),children:Y.map(s=>e.jsxs("option",{value:s.id,children:[s.name,s.is_admin?" [ç®¡]":""]},s.id))})]}),e.jsx("div",{className:"toolbar-spacer"}),e.jsxs("div",{className:"muted",children:["æ›´æ–°äºï¼š",d?.updated_at?O(d.updated_at):"--"]})]})}),e.jsx(k,{title:"å…¨å±€æŒ‡æ ‡",extra:S||!d?null:e.jsxs("div",{className:"badge gray",children:["æ€»èŠ‚ç‚¹ ",d.nodes.length," Â· åœ¨çº¿ ",m.online," Â· ç¦»çº¿ ",m.offline]}),children:S||!d?e.jsx("div",{className:"kpi-grid",children:Array.from({length:4}).map((s,t)=>e.jsx("div",{className:"stat-card glass skeleton",children:e.jsx("div",{className:"skeleton-block",style:{height:"80px"}})},t))}):e.jsxs("div",{className:"kpi-grid",children:[e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"æˆåŠŸç‡"}),e.jsxs("div",{className:"kpi-main",children:[m.successRate.toFixed(1),"%"]}),e.jsxs("div",{className:`badge ${m.successRate<90?"warn":"green"}`,children:[m.failedRequests.toLocaleString("en-US")," å¤±è´¥"]})]}),e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"å¹³å‡å“åº”"}),e.jsxs("div",{className:"kpi-main",children:[Math.round(m.avgResponse)," ms"]}),e.jsx("div",{className:"badge gray",children:"è¿‘ 24h"})]}),e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"è¯·æ±‚æ€»æ•°"}),e.jsx("div",{className:"kpi-main",children:m.totalRequests.toLocaleString("en-US")}),e.jsx("div",{className:"badge gray",children:"ç´¯è®¡"})]}),e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"çŠ¶æ€åˆ†å¸ƒ"}),e.jsxs("div",{className:"kpi-main",children:["ğŸŸ¢ ",m.online," / ğŸ”´ ",m.offline," / â¸ ",m.disabled]}),e.jsx("div",{className:"badge gray",children:"åœ¨çº¿ / ç¦»çº¿ / åœç”¨"})]})]})}),e.jsx(k,{title:"èŠ‚ç‚¹å®æ—¶çŠ¶æ€",extra:e.jsx("div",{className:"badge gray",children:"æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–° Â· WebSocket å¢é‡æ›´æ–°"}),children:S?e.jsx("div",{className:"nodes-grid",children:Array.from({length:3}).map((s,t)=>e.jsx("div",{className:"monitor-card skeleton",children:e.jsx("div",{className:"skeleton-block"})},t))}):d&&d.nodes.length>0?e.jsx("div",{className:"nodes-grid",children:d.nodes.map(s=>e.jsx(ge,{node:s,historyRefreshKey:te,healthEvent:re[s.id],shareToken:o},s.id))}):e.jsx("div",{className:"empty",children:"æš‚æ— èŠ‚ç‚¹æ•°æ®"})}),!n&&j&&e.jsxs(k,{title:"åˆ†äº«å¤§å±",extra:e.jsx("small",{className:"muted",children:"ç”Ÿæˆåªè¯»é“¾æ¥ï¼Œä¾¿äºå›¢é˜ŸæŸ¥çœ‹"}),children:[e.jsxs("div",{className:"share-toolbar",children:[e.jsxs("label",{children:["è¿‡æœŸæ—¶é—´",e.jsxs("select",{value:B,onChange:s=>se(s.target.value),children:[e.jsx("option",{value:"1h",children:"1 å°æ—¶"}),e.jsx("option",{value:"24h",children:"24 å°æ—¶"}),e.jsx("option",{value:"168h",children:"7 å¤©"}),e.jsx("option",{value:"permanent",children:"æ°¸ä¹…"})]})]}),e.jsx("button",{className:"btn primary",type:"button",onClick:ce,disabled:C||!i,children:C?"ç”Ÿæˆä¸­...":"ç”Ÿæˆåˆ†äº«é“¾æ¥"})]}),e.jsxs("div",{className:"share-list",children:[e.jsxs("div",{className:"share-row share-head",children:[e.jsx("span",{children:"é“¾æ¥"}),e.jsx("span",{children:"çŠ¶æ€"}),e.jsx("span",{children:"æˆªæ­¢"}),e.jsx("span",{children:"æ“ä½œ"})]}),C?e.jsx("div",{className:"share-row",children:e.jsx("div",{className:"skeleton-block",style:{width:"100%"}})}):W.length===0?e.jsx("div",{className:"share-row",children:"æš‚æ— åˆ†äº«"}):W.map(s=>{const t=s.expire_at?(M(s.expire_at)?.getTime()||0)<Date.now():!1,l=oe(s);return e.jsxs("div",{className:"share-row",children:[e.jsx("div",{className:"share-link",title:l,children:l}),e.jsx("div",{className:"share-status",children:s.revoked?e.jsx("span",{className:"pill danger",children:"å·²æ’¤é”€"}):t?e.jsx("span",{className:"pill warn",children:"å·²è¿‡æœŸ"}):e.jsx("span",{className:"pill ok",children:"æœ‰æ•ˆ"})}),e.jsx("div",{children:s.expire_at?O(s.expire_at):"æ°¸ä¹…"}),e.jsxs("div",{className:"share-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>le(l),children:"å¤åˆ¶"}),e.jsx("button",{className:"btn danger",type:"button",onClick:()=>ie(s.id),disabled:s.revoked,children:"æ’¤é”€"})]})]},s.id)})]})]}),e.jsx(je,{message:P?.message,type:P?.type})]})}export{Te as default};
