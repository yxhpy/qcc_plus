import{l as xe,r as a,j as e}from"./vendor-HVpYYIdB.js";import{C as k}from"./Card-Bmh2bB8_.js";import{u as pe,N as ge}from"./useMonitorWebSocket-DYvqJ2wd.js";import{T as je}from"./Toast-BukLN0_W.js";import{u as _e,d as Ne,e as ve,c as g}from"./index-cFc9t1GX.js";import{p as E,f as J}from"./date-DeDlRUHn.js";import"./charts-USIkmnH5.js";function Te({shared:r=!1}){const O=xe(),o=r?O.token:void 0,{isAdmin:j}=_e(),{preference:M,setPreference:I,resetToDefault:Q}=Ne(),{getSetting:V}=ve(),y=V("monitor.refresh_interval_ms",3e4),[X,Y]=a.useState([]),[i,A]=a.useState(""),[u,$]=a.useState(null),[Z,_]=a.useState(!0),[D,L]=a.useState(!1),[S,ee]=a.useState(!0),[H,P]=a.useState(null),[U,W]=a.useState([]),[w,N]=a.useState(!1),[K,se]=a.useState("24h"),[te,ae]=a.useState(0),[re,B]=a.useState({}),F=a.useRef(""),ne=r?void 0:i||void 0,{connected:z,lastMessage:x}=pe(ne,o),d=(s,t="success")=>{P({message:s,type:t}),setTimeout(()=>P(null),2200)},G=a.useCallback(async()=>{_(!0);try{const s=await g.getAccounts();Y(s),A(t=>t||(s[0]?.id??""))}catch{d("åŠ è½½è´¦å·å¤±è´¥","error")}finally{_(!1)}},[]),p=a.useCallback(async(s=!0)=>{if(!(r&&!o)&&!(!r&&!i)){s&&_(!0),L(!0);try{const t=r&&o?await g.getSharedMonitor(o):await g.getMonitorDashboard(i),l=(t.nodes||[]).map(m=>m.id).sort().join("|"),n=`${r?"shared":i||"default"}|${o||""}|${l}`;$(t),ae(m=>n!==F.current?(F.current=n,m+1):m)}catch(t){d(t.message||"åŠ è½½å¤±è´¥","error")}finally{_(!1),L(!1)}}},[i,o,r]),C=a.useCallback(async()=>{if(!(r||!j||!i)){N(!0);try{const s=await g.getMonitorShares(i);W(s.shares||[])}catch{d("åŠ è½½åˆ†äº«åˆ—è¡¨å¤±è´¥","error")}finally{N(!1)}}},[i,j,r]);a.useEffect(()=>{r||G()},[G,r]),a.useEffect(()=>{r?o&&p():i&&p()},[i,p,r,o]),a.useEffect(()=>{if(!S)return;const s=setInterval(()=>p(!1),y);return()=>clearInterval(s)},[S,p,y]),a.useEffect(()=>{C()},[C]),a.useEffect(()=>{B({})},[i,o]),a.useEffect(()=>{if(!x)return;if(x.type==="health_check"){const t=x.payload;B(l=>({...l,[t.node_id]:{node_id:t.node_id,check_time:t.check_time,success:t.success,response_time_ms:t.response_time_ms??0,error_message:t.error_message||"",check_method:t.check_method||"api"}}));return}if(x.type!=="node_status"&&x.type!=="node_metrics")return;const s=x.payload;$(t=>{if(!t)return t;const l=t.nodes.findIndex(T=>T.id===s.node_id);if(l===-1)return t;const n=t.nodes[l],m={success_rate:s.traffic?.success_rate??s.success_rate??n.traffic?.success_rate??0,avg_response_time:s.traffic?.avg_response_time??s.avg_response_time??n.traffic?.avg_response_time??0,total_requests:s.traffic?.total_requests??s.total_requests??n.traffic?.total_requests??0,failed_requests:s.traffic?.failed_requests??s.failed_requests??n.traffic?.failed_requests??0},v={status:s.health?.status??n.health?.status??"up",last_check_at:s.health?.last_check_at??s.timestamp??n.health?.last_check_at??null,last_ping_ms:s.health?.last_ping_ms??s.last_ping_ms??n.health?.last_ping_ms??0,last_ping_err:s.health?.last_ping_err??n.health?.last_ping_err??"",check_method:(s.health?.check_method??n.health?.check_method??"api").toLowerCase()},b={...n,status:s.status||n.status,last_error:s.error??n.last_error,traffic:m,health:v},R=s.traffic?.success_rate!==void 0||s.success_rate!==void 0,c=s.timestamp||v.last_check_at||void 0;if(R&&c){const T=(n.trend_24h||[]).filter(q=>q.timestamp!==c).concat({timestamp:c,success_rate:m.success_rate,avg_time:m.avg_response_time}).sort((q,me)=>{const ue=E(q.timestamp)?.getTime()||0,fe=E(me.timestamp)?.getTime()||0;return ue-fe}).slice(-96);b.trend_24h=T}const f=t.nodes.slice();return f[l]=b,{...t,nodes:f,updated_at:c||t.updated_at}})},[x]);const h=a.useMemo(()=>{const s=u?.nodes||[],t=s.reduce((c,f)=>c+Number(f.traffic?.total_requests||0),0),l=s.reduce((c,f)=>c+Number(f.traffic?.failed_requests||0),0),n=t>0?(t-l)/t*100:100,m=s.length>0?s.reduce((c,f)=>c+Number(f.traffic?.avg_response_time||0),0)/s.length:0,v=s.filter(c=>c.status==="online").length,b=s.filter(c=>c.status==="offline"||c.status==="degraded").length,R=s.filter(c=>c.status==="disabled").length;return{totalRequests:t,failedRequests:l,successRate:n,avgResponse:m,online:v,offline:b,disabled:R}},[u]),ce=async()=>{if(!i){d("è¯·é€‰æ‹©è´¦å·","error");return}N(!0);try{const s=await g.createMonitorShare({account_id:i,expire_in:K});W(t=>[s,...t]),d("å·²ç”Ÿæˆåˆ†äº«é“¾æ¥")}catch(s){d(s.message||"åˆ›å»ºå¤±è´¥","error")}finally{N(!1)}},ie=async s=>{try{await g.revokeMonitorShare(s),d("å·²æ’¤é”€"),C()}catch(t){d(t.message||"æ’¤é”€å¤±è´¥","error")}},le=async s=>{try{await navigator.clipboard.writeText(s),d("å·²å¤åˆ¶é“¾æ¥")}catch{d("å¤åˆ¶å¤±è´¥","error")}},oe=s=>s.share_url||`${window.location.origin}/monitor/share/${s.token}`,de=r?"å…±äº«ç›‘æ§å¤§å±":"ç›‘æ§å¤§å±",he=r?"åªè¯»æ¨¡å¼ Â· é€šè¿‡åˆ†äº«é“¾æ¥æŸ¥çœ‹å®æ—¶çŠ¶æ€":"å®æ—¶æ´å¯ŸèŠ‚ç‚¹çŠ¶æ€ä¸ 24 å°æ—¶è¶‹åŠ¿";return e.jsxs("div",{className:"monitor-page",children:[e.jsxs("div",{className:"monitor-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:de}),e.jsx("p",{className:"sub",children:he})]}),e.jsxs("div",{className:"monitor-header-actions",children:[e.jsxs("div",{className:`ws-pill ${z?"on":"off"}`,children:[e.jsx("span",{className:"status-dot"}),"WebSocket ",z?"å·²è¿æ¥":"æœªè¿æ¥"]}),e.jsxs("div",{className:"monitor-settings",children:[e.jsxs("label",{className:"setting-toggle",children:[e.jsx("span",{children:"ä»£ç†"}),e.jsxs("span",{className:"toggle-mini",children:[e.jsx("input",{type:"checkbox",checked:M.showProxy,onChange:s=>I({showProxy:s.target.checked})}),e.jsx("span",{className:"slider"})]})]}),e.jsxs("label",{className:"setting-toggle",children:[e.jsx("span",{children:"æ¢æ´»"}),e.jsxs("span",{className:"toggle-mini",children:[e.jsx("input",{type:"checkbox",checked:M.showHealth,onChange:s=>I({showHealth:s.target.checked})}),e.jsx("span",{className:"slider"})]})]}),e.jsx("button",{className:"reset-btn",onClick:Q,children:"é‡ç½®"})]}),!r&&e.jsxs("label",{className:"auto-refresh",children:[e.jsxs("span",{className:"toggle-mini",children:[e.jsx("input",{type:"checkbox",checked:S,onChange:s=>ee(s.target.checked)}),e.jsx("span",{className:"slider"})]}),"è‡ªåŠ¨åˆ·æ–° ",Math.round(y/1e3),"s"]}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>p(),disabled:D,children:D?"åˆ·æ–°ä¸­...":"ç«‹å³åˆ·æ–°"})]})]}),!r&&e.jsx(k,{children:e.jsxs("div",{className:"monitor-toolbar",children:[j&&e.jsxs("label",{children:["é€‰æ‹©è´¦å·",e.jsx("select",{value:i,onChange:s=>A(s.target.value),children:X.map(s=>e.jsxs("option",{value:s.id,children:[s.name,s.is_admin?" [ç®¡]":""]},s.id))})]}),e.jsx("div",{className:"toolbar-spacer"}),e.jsxs("div",{className:"muted",children:["æ›´æ–°äºï¼š",u?.updated_at?J(u.updated_at):"--"]})]})}),e.jsx(k,{title:"å…¨å±€æŒ‡æ ‡",extra:e.jsxs("div",{className:"badge gray",children:["æ€»èŠ‚ç‚¹ ",u?.nodes.length??0," Â· åœ¨çº¿ ",h.online," Â· ç¦»çº¿ ",h.offline]}),children:e.jsxs("div",{className:"kpi-grid",children:[e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"æˆåŠŸç‡"}),e.jsxs("div",{className:"kpi-main",children:[h.successRate.toFixed(1),"%"]}),e.jsxs("div",{className:`badge ${h.successRate<90?"warn":"green"}`,children:[h.failedRequests.toLocaleString("en-US")," å¤±è´¥"]})]}),e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"å¹³å‡å“åº”"}),e.jsxs("div",{className:"kpi-main",children:[Math.round(h.avgResponse)," ms"]}),e.jsx("div",{className:"badge gray",children:"è¿‘ 24h"})]}),e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"è¯·æ±‚æ€»æ•°"}),e.jsx("div",{className:"kpi-main",children:h.totalRequests.toLocaleString("en-US")}),e.jsx("div",{className:"badge gray",children:"ç´¯è®¡"})]}),e.jsxs("div",{className:"stat-card glass",children:[e.jsx("span",{className:"muted-title",children:"çŠ¶æ€åˆ†å¸ƒ"}),e.jsxs("div",{className:"kpi-main",children:["ğŸŸ¢ ",h.online," / ğŸ”´ ",h.offline," / â¸ ",h.disabled]}),e.jsx("div",{className:"badge gray",children:"åœ¨çº¿ / ç¦»çº¿ / åœç”¨"})]})]})}),e.jsx(k,{title:"èŠ‚ç‚¹å®æ—¶çŠ¶æ€",extra:e.jsx("div",{className:"badge gray",children:"æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–° Â· WebSocket å¢é‡æ›´æ–°"}),children:Z?e.jsx("div",{className:"nodes-grid",children:Array.from({length:3}).map((s,t)=>e.jsx("div",{className:"monitor-card skeleton",children:e.jsx("div",{className:"skeleton-block"})},t))}):u&&u.nodes.length>0?e.jsx("div",{className:"nodes-grid",children:u.nodes.map(s=>e.jsx(ge,{node:s,historyRefreshKey:te,healthEvent:re[s.id],shareToken:o},s.id))}):e.jsx("div",{className:"empty",children:"æš‚æ— èŠ‚ç‚¹æ•°æ®"})}),!r&&j&&e.jsxs(k,{title:"åˆ†äº«å¤§å±",extra:e.jsx("small",{className:"muted",children:"ç”Ÿæˆåªè¯»é“¾æ¥ï¼Œä¾¿äºå›¢é˜ŸæŸ¥çœ‹"}),children:[e.jsxs("div",{className:"share-toolbar",children:[e.jsxs("label",{children:["è¿‡æœŸæ—¶é—´",e.jsxs("select",{value:K,onChange:s=>se(s.target.value),children:[e.jsx("option",{value:"1h",children:"1 å°æ—¶"}),e.jsx("option",{value:"24h",children:"24 å°æ—¶"}),e.jsx("option",{value:"168h",children:"7 å¤©"}),e.jsx("option",{value:"permanent",children:"æ°¸ä¹…"})]})]}),e.jsx("button",{className:"btn primary",type:"button",onClick:ce,disabled:w||!i,children:w?"ç”Ÿæˆä¸­...":"ç”Ÿæˆåˆ†äº«é“¾æ¥"})]}),e.jsxs("div",{className:"share-list",children:[e.jsxs("div",{className:"share-row share-head",children:[e.jsx("span",{children:"é“¾æ¥"}),e.jsx("span",{children:"çŠ¶æ€"}),e.jsx("span",{children:"æˆªæ­¢"}),e.jsx("span",{children:"æ“ä½œ"})]}),w?e.jsx("div",{className:"share-row",children:e.jsx("div",{className:"skeleton-block",style:{width:"100%"}})}):U.length===0?e.jsx("div",{className:"share-row",children:"æš‚æ— åˆ†äº«"}):U.map(s=>{const t=s.expire_at?(E(s.expire_at)?.getTime()||0)<Date.now():!1,l=oe(s);return e.jsxs("div",{className:"share-row",children:[e.jsx("div",{className:"share-link",title:l,children:l}),e.jsx("div",{className:"share-status",children:s.revoked?e.jsx("span",{className:"pill danger",children:"å·²æ’¤é”€"}):t?e.jsx("span",{className:"pill warn",children:"å·²è¿‡æœŸ"}):e.jsx("span",{className:"pill ok",children:"æœ‰æ•ˆ"})}),e.jsx("div",{children:s.expire_at?J(s.expire_at):"æ°¸ä¹…"}),e.jsxs("div",{className:"share-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>le(l),children:"å¤åˆ¶"}),e.jsx("button",{className:"btn danger",type:"button",onClick:()=>ie(s.id),disabled:s.revoked,children:"æ’¤é”€"})]})]},s.id)})]})]}),e.jsx(je,{message:H?.message,type:H?.type})]})}export{Te as default};
