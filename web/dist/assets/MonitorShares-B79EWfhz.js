import{r as a,j as t}from"./vendor-HVpYYIdB.js";import{C as q}from"./Card-Bmh2bB8_.js";import{u as z,M as J}from"./useDialog-CfRkIH_r.js";import{T as K}from"./Toast-BukLN0_W.js";import{u as O,c as p}from"./index-qk43s-9n.js";import{f as A}from"./date-DeDlRUHn.js";import"./charts-USIkmnH5.js";const h=20;function re(){const{isAdmin:n,user:c,loading:l}=O(),u=z(),[g,f]=a.useState([]),[r,b]=a.useState(""),[x,$]=a.useState([]),[v,I]=a.useState(0),[D,P]=a.useState(!1),[d,N]=a.useState(1),[y,C]=a.useState(!0),[L,m]=a.useState(!1),[w,k]=a.useState(!1),[S,T]=a.useState(null),i=(e,s="success")=>{T({message:e,type:s}),setTimeout(()=>T(null),2200)},M=a.useCallback(async()=>{if(n)try{const e=await p.getAccounts();f(e),b(s=>s||(e[0]?.id??""))}catch{i("加载账号列表失败","error")}},[n]);a.useEffect(()=>{l||(n?M():c?.id&&b(c.id))},[l,n,c,M]),a.useEffect(()=>{N(1)},[r]);const j=a.useCallback(async()=>{if(!l&&!(n&&!r)){C(!0);try{const{shares:e,total:s}=await p.getMonitorShares(n?r:void 0,h,(d-1)*h);$(e);const o=typeof s=="number"?s:(d-1)*h+e.length+(e.length===h?1:0);I(o),P(e.length===h)}catch(e){i(e.message||"加载分享链接失败","error")}finally{C(!1)}}},[r,l,n,d]);a.useEffect(()=>{j()},[j]);const _=a.useMemo(()=>v>0?Math.ceil(v/h):(x.length>0,1),[v,x.length]),R=async e=>{if(!w){k(!0);try{const s={expire_in:e};n&&r&&(s.account_id=r);const o=await p.createMonitorShare(s);i("分享链接创建成功"),m(!1),await j();const Z=o.share_url||`${window.location.origin}/monitor/share/${o.token}`;try{await navigator.clipboard.writeText(Z),i("分享链接已复制到剪贴板")}catch{i("已生成链接，请手动复制","error")}}catch(s){i(s.message||"创建失败","error")}finally{k(!1)}}},B=async e=>{if(await u.confirm({title:"确认撤销",message:"撤销后链接将不可访问，确定继续？"}))try{await p.revokeMonitorShare(e),i("分享链接已撤销"),j()}catch(o){i(o.message||"撤销失败","error")}},F=async e=>{const s=e.share_url||`${window.location.origin}/monitor/share/${e.token}`;try{await navigator.clipboard.writeText(s),i("分享链接已复制")}catch{i("复制失败，请手动复制","error")}},E=e=>{if(!e.expire_at)return!1;const s=new Date(e.expire_at);return Number.isNaN(s.getTime())?!1:s<new Date},G=e=>e.revoked||E(e),H=e=>e?e.length>16?`${e.slice(0,16)}...`:e:"--",U=e=>e?`/monitor/share/${e.length>8?`${e.slice(0,8)}...`:e}`:"--",W=!D&&d>=_;return t.jsxs("div",{className:"monitor-shares-page",children:[t.jsxs("div",{className:"monitor-shares-header",children:[t.jsxs("div",{children:[t.jsx("h1",{children:"监控分享链接"}),t.jsx("p",{className:"sub",children:"创建只读分享链接，让外部用户也能查看监控大屏。"})]}),t.jsxs("div",{className:"monitor-shares-actions",children:[n&&t.jsx("select",{value:r,onChange:e=>b(e.target.value),children:g.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("button",{className:"btn primary",type:"button",onClick:()=>m(!0),children:"➕ 创建分享链接"})]})]}),t.jsxs(q,{title:"分享链接列表",children:[t.jsxs("table",{className:"shares-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Token"}),t.jsx("th",{children:"分享 URL"}),t.jsx("th",{children:"创建时间"}),t.jsx("th",{children:"过期时间"}),t.jsx("th",{children:"状态"}),t.jsx("th",{style:{minWidth:160},children:"操作"})]})}),t.jsx("tbody",{children:y?t.jsx("tr",{children:t.jsx("td",{colSpan:6,children:t.jsx("div",{className:"table-skeleton"})})}):x.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:6,style:{textAlign:"center",color:"var(--text-muted)"},children:"暂无分享链接"})}):x.map(e=>{const s=E(e),o=G(e);return t.jsxs("tr",{className:o?"inactive":"",children:[t.jsx("td",{children:t.jsx("code",{children:H(e.token)})}),t.jsx("td",{children:t.jsx("code",{className:"share-url",children:U(e.token)})}),t.jsx("td",{children:A(e.created_at)}),t.jsx("td",{children:e.expire_at?A(e.expire_at):"永久"}),t.jsx("td",{children:e.revoked?t.jsx("span",{className:"status-badge revoked",children:"已撤销"}):s?t.jsx("span",{className:"status-badge expired",children:"已过期"}):t.jsx("span",{className:"status-badge active",children:"有效"})}),t.jsx("td",{children:t.jsxs("div",{className:"table-actions",children:[t.jsx("button",{className:"btn ghost",onClick:()=>F(e),disabled:o,children:"复制"}),!e.revoked&&t.jsx("button",{className:"btn danger",onClick:()=>B(e.id),children:"撤销"})]})})]},e.id)})})]}),t.jsxs("div",{className:"pagination",children:[t.jsx("button",{className:"btn ghost",onClick:()=>N(e=>Math.max(1,e-1)),disabled:d===1||y,children:"上一页"}),t.jsxs("span",{children:["第 ",d," / 共 ",_," 页"]}),t.jsx("button",{className:"btn ghost",onClick:()=>N(e=>e+1),disabled:W||y,children:"下一页"})]})]}),t.jsx(J,{open:L,title:"创建分享链接",onClose:()=>m(!1),children:t.jsx(Q,{onSubmit:R,submitting:w,onCancel:()=>m(!1)})}),S&&t.jsx(K,{message:S.message,type:S.type})]})}function Q({onSubmit:n,submitting:c,onCancel:l}){const[u,g]=a.useState("24h"),f=r=>{r.preventDefault(),n(u)};return t.jsxs("form",{className:"share-form",onSubmit:f,children:[t.jsxs("label",{children:["有效期",t.jsxs("select",{value:u,onChange:r=>g(r.target.value),children:[t.jsx("option",{value:"1h",children:"1 小时"}),t.jsx("option",{value:"24h",children:"24 小时"}),t.jsx("option",{value:"168h",children:"7 天"}),t.jsx("option",{value:"permanent",children:"永久"})]})]}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{className:"btn ghost",type:"button",onClick:l,disabled:c,children:"取消"}),t.jsx("button",{className:"btn primary",type:"submit",disabled:c,children:c?"创建中...":"创建"})]})]})}export{re as default};
