import{r as a,j as e}from"./vendor-HVpYYIdB.js";import{C as N}from"./Card-B8iKcX7i.js";import{T as be}from"./Toast-D5AN34u6.js";import{u as je}from"./useDialog-C5wEG-lT.js";import{c as d}from"./index-Cl6wuNBU.js";import{f as S}from"./date-DeDlRUHn.js";import"./charts-USIkmnH5.js";const C=[{value:"wechat_work",label:"企业微信"},{value:"dingtalk",label:"钉钉（待支持）"},{value:"email",label:"邮件（待支持）"}],fe={node:"节点相关",request:"请求相关",account:"账号相关",system:"系统相关"};function ke(){const[b,q]=a.useState([]),[Z,U]=a.useState(!1),[ee,V]=a.useState(!1),[c,P]=a.useState(""),[u,w]=a.useState(""),[k,T]=a.useState(C[0]?.value||"wechat_work"),[m,_]=a.useState(""),[E,I]=a.useState("true"),[B,O]=a.useState([]),[te,j]=a.useState(!1),[p,f]=a.useState([]),[z,x]=a.useState(new Set),[o,v]=a.useState(""),[se,G]=a.useState(!1),[R,L]=a.useState(""),[W,H]=a.useState(""),[A,J]=a.useState(""),[ne,K]=a.useState(!1),[Q,X]=a.useState(null),ae=je(),M=a.useRef(null),$=a.useRef(null),D=a.useRef(null),l=(t,s="success")=>{X({message:t,type:s}),setTimeout(()=>X(null),2200)},F=()=>{P(""),w(""),T(C[0]?.value||"wechat_work"),_(""),I("true")},Y=()=>{M.current&&M.current.scrollIntoView({behavior:"smooth",block:"start"})},le=()=>{$.current&&$.current.scrollIntoView({behavior:"smooth",block:"start"})},ie=()=>{D.current&&D.current.scrollIntoView({behavior:"smooth",block:"start"})},y=async()=>{U(!0);try{const t=await d.getNotificationChannels(),s=Array.isArray(t)?t:[];q(s);const n=s[0]?.id??"";v(i=>i||n),L(i=>i||n)}catch(t){console.error("Failed to load notification channels:",t),q([]),l("加载渠道失败","error")}finally{U(!1)}},re=async()=>{j(!0);try{const t=await d.getEventTypes();O(Array.isArray(t)?t:[])}catch(t){console.error("Failed to load event types:",t),O([]),l("加载事件类型失败","error")}finally{j(!1)}},g=async t=>{if(t){j(!0);try{const s=await d.getNotificationSubscriptions(t),n=Array.isArray(s)?s:[];f(n),x(new Set(n.filter(i=>i.enabled).map(i=>i.event_type)))}catch(s){console.error("Failed to load notification subscriptions:",s),f([]),x(new Set),l("加载订阅失败","error")}finally{j(!1)}}};a.useEffect(()=>{y(),re()},[]),a.useEffect(()=>{o?g(o):(f([]),x(new Set))},[o]);const oe=async t=>{if(t.preventDefault(),!u.trim()){l("请输入渠道名称","error");return}if(!c&&!m.trim()){l("Webhook URL 必填","error");return}V(!0);try{if(c){const s={name:u.trim(),channel_type:k,enabled:E==="true"};m.trim()&&(s.config={webhook_url:m.trim()}),await d.updateNotificationChannel(c,s),l("渠道已更新")}else await d.createNotificationChannel({name:u.trim(),channel_type:k,enabled:E==="true",config:{webhook_url:m.trim()}}),l("渠道已创建");F(),y()}catch(s){l(s.message||"保存失败","error")}finally{V(!1)}},ce=t=>{P(t.id),w(t.name),T(t.channel_type),I(t.enabled?"true":"false"),_(""),Y()},de=async t=>{if(await ae.confirm({title:"确认删除",message:"删除后将停止发送通知，是否继续？"}))try{await d.deleteNotificationChannel(t),l("渠道已删除"),o===t&&(v(""),f([]),x(new Set)),y()}catch(n){l(n.message||"删除失败","error")}},he=a.useMemo(()=>{const t={};return B.forEach(s=>{const n=s.category||"system";t[n]||(t[n]=[]),t[n].push(s)}),t},[B]),ue=a.useMemo(()=>new Map(p.map(t=>[t.event_type,t])),[p]),me=t=>{x(s=>{const n=new Set(s);return n.has(t)?n.delete(t):n.add(t),n})},pe=async()=>{if(!o){l("请选择一个渠道","error");return}const t=new Set(z),s=new Map(p.map(r=>[r.event_type,r])),n=Array.from(t).filter(r=>!s.has(r)),i=p.filter(r=>t.has(r.event_type)&&!r.enabled),h=p.filter(r=>!t.has(r.event_type)&&r.enabled);G(!0);try{n.length&&await d.createNotificationSubscriptions({channel_id:o,event_types:n,enabled:!0}),i.length&&await Promise.all(i.map(r=>d.updateNotificationSubscription(r.id,!0))),h.length&&await Promise.all(h.map(r=>d.updateNotificationSubscription(r.id,!1))),l("订阅已保存"),g(o)}catch(r){l(r.message||"保存订阅失败","error")}finally{G(!1)}},xe=async()=>{if(!R){l("请选择渠道","error");return}if(!W.trim()||!A.trim()){l("请输入标题和内容","error");return}K(!0);try{await d.testNotification({channel_id:R,title:W.trim(),content:A.trim()}),l("测试通知已发送")}catch(t){l(t.message||"发送失败","error")}finally{K(!1)}};return e.jsxs("div",{className:"notifications-page",children:[e.jsxs("div",{className:"notifications-header",children:[e.jsx("h1",{children:"通知管理"}),e.jsx("p",{className:"sub",children:"配置通知渠道，选择要订阅的事件并发送测试通知。"})]}),e.jsxs(N,{title:c?`编辑渠道：${u||"未命名"}`:"创建通知渠道",children:[e.jsxs("form",{className:"inline-form",onSubmit:oe,ref:M,autoComplete:"off",children:[e.jsx("input",{type:"hidden",value:c}),e.jsxs("label",{children:["渠道名称",e.jsx("input",{value:u,onChange:t=>w(t.target.value),placeholder:"输入渠道名称",required:!0})]}),e.jsxs("label",{children:["渠道类型",e.jsx("select",{value:k,onChange:t=>T(t.target.value),children:C.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("label",{children:["Webhook URL ",c?e.jsx("span",{className:"muted",children:"（留空则不修改）"}):null,e.jsx("input",{value:m,onChange:t=>_(t.target.value),placeholder:c?"留空保持不变":"https://example.com/webhook",type:"url",required:!c})]}),e.jsxs("label",{children:["启用状态",e.jsxs("select",{value:E,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"true",children:"启用"}),e.jsx("option",{value:"false",children:"停用"})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{className:"btn primary",type:"submit",disabled:ee,children:c?"更新渠道":"创建渠道"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:F,children:c?"取消编辑":"清空"})]})]}),e.jsx("small",{className:"muted",style:{display:"block",marginTop:12},children:"创建时需填写 Webhook URL，编辑时不显示原值以保护敏感信息。"})]}),e.jsxs(N,{title:"渠道列表",extra:e.jsx("small",{className:"muted",children:"编辑、删除或一键跳转到测试/订阅区域。"}),children:[e.jsxs("div",{className:"toolbar",children:[e.jsx("button",{className:"btn primary",type:"button",onClick:()=>{F(),Y()},children:"➕ 新建渠道"}),e.jsx("div",{className:"spacer"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:y,children:"刷新"})]}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"channels-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{minWidth:140},children:"ID"}),e.jsx("th",{children:"名称"}),e.jsx("th",{children:"类型"}),e.jsx("th",{children:"状态"}),e.jsx("th",{style:{minWidth:170},children:"创建时间"}),e.jsx("th",{style:{minWidth:170},children:"更新时间"}),e.jsx("th",{style:{minWidth:220},children:"操作"})]})}),e.jsx("tbody",{children:Z?e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:e.jsx("div",{className:"skeleton",style:{height:24}})})}):b.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"暂无渠道"})}):b.map(t=>{const s=C.find(n=>n.value===t.channel_type)?.label||t.channel_type;return e.jsxs("tr",{className:o===t.id?"selected":void 0,children:[e.jsx("td",{children:e.jsx("code",{className:"mono",children:t.id})}),e.jsx("td",{children:t.name}),e.jsx("td",{children:s}),e.jsx("td",{children:e.jsxs("span",{className:`status-badge ${t.enabled?"on":"off"}`,children:[e.jsx("span",{className:"dot"}),t.enabled?"启用":"停用"]})}),e.jsx("td",{children:e.jsx("div",{className:"time-cell",children:S(t.created_at)})}),e.jsx("td",{children:e.jsx("div",{className:"time-cell",children:t.updated_at?S(t.updated_at):"-"})}),e.jsx("td",{children:e.jsxs("div",{className:"table-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>ce(t),children:"编辑"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>{v(t.id),le()},children:"订阅"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>{L(t.id),ie()},children:"测试"}),e.jsx("button",{className:"btn danger",type:"button",onClick:()=>de(t.id),children:"删除"})]})})]},t.id)})})]})})]}),e.jsxs("div",{className:"notifications-grid",children:[e.jsx(N,{title:"事件订阅管理",extra:e.jsx("small",{className:"muted",children:"选择渠道后，勾选需要的事件类型。"}),children:e.jsxs("div",{ref:$,children:[e.jsxs("div",{className:"subscription-toolbar",children:[e.jsxs("label",{children:["选择渠道",e.jsxs("select",{value:o,onChange:t=>v(t.target.value),children:[e.jsx("option",{value:"",children:"请选择"}),b.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>o&&g(o),children:"刷新订阅"})]}),o?te?e.jsx("div",{className:"empty-box",children:"加载中..."}):e.jsx("div",{className:"event-groups",children:Object.entries(fe).map(([t,s])=>{const n=he[t]||[];return e.jsxs("div",{className:"event-group",children:[e.jsxs("div",{className:"group-head",children:[e.jsxs("div",{children:[e.jsx("h4",{children:s}),e.jsx("small",{className:"muted",children:n.length?`共 ${n.length} 项`:"暂无事件"})]}),e.jsxs("span",{className:"pill light",children:[t,".*"]})]}),n.length===0?e.jsx("div",{className:"empty-box small",children:"暂未提供该分类事件"}):e.jsx("div",{className:"event-list",children:n.map(i=>{const h=ue.get(i.type);return e.jsxs("label",{className:"event-item",children:[e.jsx("input",{type:"checkbox",checked:z.has(i.type),onChange:()=>me(i.type)}),e.jsxs("div",{children:[e.jsx("div",{className:"event-type",children:i.type}),e.jsx("div",{className:"event-desc",children:i.description}),e.jsx("div",{className:"event-meta muted",children:h?`创建：${S(h.created_at)}${h.updated_at?` · 更新：${S(h.updated_at)}`:""}`:"尚未创建订阅"})]})]},i.type)})})]},t)})}):e.jsx("div",{className:"empty-box",children:"先选择一个渠道以管理订阅。"}),e.jsxs("div",{className:"form-actions",style:{marginTop:16},children:[e.jsx("button",{className:"btn primary",type:"button",onClick:pe,disabled:!o||se,children:"保存订阅"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>o&&g(o),children:"重置"})]})]})}),e.jsx(N,{title:"发送测试通知",extra:e.jsx("small",{className:"muted",children:"用于验证渠道配置是否可用。"}),children:e.jsxs("div",{className:"test-card",ref:D,children:[e.jsxs("label",{children:["选择渠道",e.jsxs("select",{value:R,onChange:t=>L(t.target.value),children:[e.jsx("option",{value:"",children:"请选择"}),b.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("label",{children:["标题",e.jsx("input",{value:W,onChange:t=>H(t.target.value),placeholder:"测试通知标题"})]}),e.jsxs("label",{children:["内容",e.jsx("textarea",{value:A,onChange:t=>J(t.target.value),placeholder:"测试通知内容",rows:4})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{className:"btn primary",type:"button",onClick:xe,disabled:ne,children:"发送测试"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>{H(""),J("")},children:"清空"})]})]})})]}),e.jsx(be,{message:Q?.message,type:Q?.type})]})}export{ke as default};
