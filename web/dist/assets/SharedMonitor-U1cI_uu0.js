import{l as H,r as c,j as a}from"./vendor-HVpYYIdB.js";import{u as R,N as C}from"./useMonitorWebSocket-CY83HoZY.js";import{c as K}from"./index-DduIjbRA.js";import{p as v,f as L}from"./date-DeDlRUHn.js";import"./charts-USIkmnH5.js";function W(){const{token:i}=H(),[d,m]=c.useState(null),[u,p]=c.useState(""),[q,g]=c.useState(!0),[E,b]=c.useState(0),[S,x]=c.useState({}),{connected:j,lastMessage:o}=R(void 0,i);c.useEffect(()=>{async function e(){if(!i){p("æ— æ•ˆçš„åˆ†äº«é“¾æŽ¥"),g(!1);return}try{const t=await K.getSharedMonitor(i);m(t),b(n=>n+1),document.title=`${t.account_name} - ç›‘æŽ§å¤§å±`}catch{p("åˆ†äº«é“¾æŽ¥æ— æ•ˆæˆ–å·²è¿‡æœŸ")}finally{g(!1)}}e()},[i]),c.useEffect(()=>{x({})},[i]);const h=c.useMemo(()=>{const e=d?.nodes||[],t=e.filter(r=>r.status==="online").length,n=e.filter(r=>r.status==="offline"||r.status==="degraded").length,s=e.filter(r=>r.status==="disabled").length;return{online:t,offline:n,disabled:s}},[d]);return c.useEffect(()=>{if(!o)return;if(o.type==="health_check"){const t=o.payload;x(n=>({...n,[t.node_id]:{node_id:t.node_id,check_time:t.check_time,success:t.success,response_time_ms:t.response_time_ms??0,error_message:t.error_message||"",check_method:t.check_method||"api"}}));return}if(o.type!=="node_status"&&o.type!=="node_metrics")return;const e=o.payload;m(t=>{if(!t)return t;const n=t.nodes.findIndex(_=>_.id===e.node_id);if(n===-1)return t;const s=t.nodes[n],r={success_rate:e.traffic?.success_rate??e.success_rate??s.traffic?.success_rate??0,avg_response_time:e.traffic?.avg_response_time??e.avg_response_time??s.traffic?.avg_response_time??0,total_requests:e.traffic?.total_requests??e.total_requests??s.traffic?.total_requests??0,failed_requests:e.traffic?.failed_requests??e.failed_requests??s.traffic?.failed_requests??0},y={status:e.health?.status??s.health?.status??"up",last_check_at:e.health?.last_check_at??e.timestamp??s.health?.last_check_at??null,last_ping_ms:e.health?.last_ping_ms??e.last_ping_ms??s.health?.last_ping_ms??0,last_ping_err:e.health?.last_ping_err??s.health?.last_ping_err??"",check_method:(e.health?.check_method??s.health?.check_method??"api").toLowerCase()},k={...s,status:e.status||s.status,last_error:e.error??s.last_error,traffic:r,health:y},T=e.traffic?.success_rate!==void 0||e.success_rate!==void 0,l=e.timestamp||y.last_check_at||void 0;if(T&&l){const _=(s.trend_24h||[]).filter(f=>f.timestamp!==l).concat({timestamp:l,success_rate:r.success_rate,avg_time:r.avg_response_time}).sort((f,M)=>{const w=v(f.timestamp)?.getTime()||0,D=v(M.timestamp)?.getTime()||0;return w-D}).slice(-96);k.trend_24h=_}const N=t.nodes.slice();return N[n]=k,{...t,nodes:N,updated_at:l||t.updated_at}})},[o]),q?a.jsx("div",{className:"shared-monitor-loading",children:"åŠ è½½ä¸­..."}):u?a.jsxs("div",{className:"shared-monitor-error",children:[a.jsx("h2",{children:u}),a.jsx("p",{children:"è¯·æ£€æŸ¥åˆ†äº«é“¾æŽ¥æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è”ç³»åˆ†äº«è€…èŽ·å–æ–°çš„é“¾æŽ¥ã€‚"})]}):a.jsxs("div",{className:"shared-monitor-page",children:[a.jsxs("header",{children:[a.jsxs("h1",{children:[d?.account_name," Â· ç›‘æŽ§å¤§å±"]}),a.jsxs("div",{className:"header-info",children:[a.jsx("span",{className:`ws-status ${j?"connected":"disconnected"}`,children:j?"â— å®žæ—¶æ›´æ–°":"â—‹ æœªè¿žæŽ¥"}),a.jsxs("p",{className:"readonly-notice",children:["åªè¯»æ¨¡å¼ Â· æœ€è¿‘æ›´æ–°ï¼š",L(d?.updated_at)]}),a.jsxs("p",{className:"readonly-notice",children:["çŠ¶æ€åˆ†å¸ƒï¼šðŸŸ¢ ",h.online," / ðŸ”´ ",h.offline," / â¸ ",h.disabled]})]})]}),a.jsx("div",{className:"nodes-grid",children:d?.nodes.map(e=>a.jsx(C,{node:e,historyRefreshKey:E,healthEvent:S[e.id],shareToken:i},e.id))}),a.jsx("footer",{children:a.jsx("p",{children:"Powered by qcc_plus"})})]})}export{W as default};
