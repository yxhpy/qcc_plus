import{r as t,j as e}from"./vendor-HVpYYIdB.js";import{C as S}from"./Card-Bmh2bB8_.js";import{T as E}from"./Toast-BukLN0_W.js";import{c as d}from"./index-Bk5t0pNC.js";import"./charts-USIkmnH5.js";function P(){const[C,T]=t.useState([]),[m,k]=t.useState([]),[u,$]=t.useState([]),[c,x]=t.useState(null),[j,v]=t.useState([]),[N,g]=t.useState(!0),[p,b]=t.useState(null),[o,f]=t.useState("summary"),[a,r]=t.useState({account_id:"",node_id:"",model_id:"",from:"",to:"",limit:50}),w=(s,l="success")=>{b({message:s,type:l}),setTimeout(()=>b(null),2200)},A=async()=>{try{const s=await d.getAccounts();T(s)}catch(s){console.error("Failed to load accounts:",s)}},F=async()=>{try{const s=await d.getNodes();k(s)}catch(s){console.error("Failed to load nodes:",s)}},_=async()=>{g(!0);try{const s={...a};Object.keys(s).forEach(y=>{s[y]===""&&delete s[y]});const[l,n,D]=await Promise.all([d.getUsageSummary(s),d.getUsageSummary({...s,group_by:"model"}),d.getUsageLogs(s)]);Array.isArray(l)?x(l[0]||null):x(l),Array.isArray(n)?v(n):v([]),$(D.logs||[])}catch(s){w(s.message||"加载失败","error")}finally{g(!1)}};t.useEffect(()=>{A(),F()},[]),t.useEffect(()=>{_()},[a]);const h=s=>s<.01?`$${s.toFixed(6)}`:s<1?`$${s.toFixed(4)}`:`$${s.toFixed(2)}`,i=s=>s>=1e6?`${(s/1e6).toFixed(2)}M`:s>=1e3?`${(s/1e3).toFixed(1)}K`:s.toString(),L=s=>new Date(s).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),q=s=>m.find(n=>n.id===s)?.name||s.slice(0,8);return e.jsxs("div",{className:"usage-page",children:[e.jsxs("div",{className:"usage-header",children:[e.jsx("h1",{children:"使用统计"}),e.jsx("p",{className:"sub",children:"查看 API 调用量和费用统计。"})]}),e.jsx(S,{className:"filter-card",children:e.jsxs("div",{className:"filters",children:[e.jsxs("label",{children:[e.jsx("span",{children:"账号"}),e.jsxs("select",{value:a.account_id||"",onChange:s=>r({...a,account_id:s.target.value}),children:[e.jsx("option",{value:"",children:"全部账号"}),C.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"节点"}),e.jsxs("select",{value:a.node_id||"",onChange:s=>r({...a,node_id:s.target.value}),children:[e.jsx("option",{value:"",children:"全部节点"}),m.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"开始时间"}),e.jsx("input",{type:"datetime-local",value:a.from||"",onChange:s=>r({...a,from:s.target.value?new Date(s.target.value).toISOString():""})})]}),e.jsxs("label",{children:[e.jsx("span",{children:"结束时间"}),e.jsx("input",{type:"datetime-local",value:a.to||"",onChange:s=>r({...a,to:s.target.value?new Date(s.target.value).toISOString():""})})]}),e.jsx("button",{className:"btn ghost",onClick:()=>r({limit:50}),children:"重置"}),e.jsx("button",{className:"btn primary",onClick:_,disabled:N,children:"刷新"})]})}),c&&e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:h(c.total_cost_usd)}),e.jsx("div",{className:"stat-label",children:"总费用"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:c.total_requests.toLocaleString()}),e.jsx("div",{className:"stat-label",children:"总请求数"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:i(c.total_input_tokens)}),e.jsx("div",{className:"stat-label",children:"输入 Token"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:i(c.total_output_tokens)}),e.jsx("div",{className:"stat-label",children:"输出 Token"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsxs("div",{className:"stat-value",children:[c.total_requests>0?(c.success_requests/c.total_requests*100).toFixed(1):0,"%"]}),e.jsx("div",{className:"stat-label",children:"成功率"})]})]}),e.jsxs("div",{className:"tabs",children:[e.jsx("button",{className:`tab ${o==="summary"?"active":""}`,onClick:()=>f("summary"),children:"按模型统计"}),e.jsx("button",{className:`tab ${o==="logs"?"active":""}`,onClick:()=>f("logs"),children:"详细记录"})]}),e.jsx(S,{children:N?e.jsx("div",{className:"loading-text",children:"加载中..."}):o==="summary"?j.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用数据"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"模型"}),e.jsx("th",{children:"请求数"}),e.jsx("th",{children:"输入 Token"}),e.jsx("th",{children:"输出 Token"}),e.jsx("th",{children:"费用"})]})}),e.jsx("tbody",{children:j.map((s,l)=>e.jsxs("tr",{children:[e.jsx("td",{className:"model-cell",children:s.model_id||"未知"}),e.jsx("td",{children:s.total_requests.toLocaleString()}),e.jsx("td",{children:i(s.total_input_tokens)}),e.jsx("td",{children:i(s.total_output_tokens)}),e.jsx("td",{className:"cost-cell",children:h(s.total_cost_usd)})]},l))})]})}):u.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用记录"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"时间"}),e.jsx("th",{children:"模型"}),e.jsx("th",{children:"节点"}),e.jsx("th",{children:"输入"}),e.jsx("th",{children:"输出"}),e.jsx("th",{children:"费用"}),e.jsx("th",{children:"状态"})]})}),e.jsx("tbody",{children:u.map(s=>e.jsxs("tr",{className:s.success?"":"failed",children:[e.jsx("td",{className:"time-cell",children:L(s.created_at)}),e.jsx("td",{className:"model-cell",children:s.model_id}),e.jsx("td",{children:q(s.node_id)}),e.jsx("td",{children:i(s.input_tokens)}),e.jsx("td",{children:i(s.output_tokens)}),e.jsx("td",{className:"cost-cell",children:h(s.cost_usd)}),e.jsx("td",{children:e.jsx("span",{className:`status-dot ${s.success?"success":"failed"}`})})]},s.id))})]})})}),e.jsx(E,{message:p?.message,type:p?.type})]})}export{P as default};
