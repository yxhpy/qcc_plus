import{r as t,j as e}from"./vendor-HVpYYIdB.js";import{C as w}from"./Card-B8iKcX7i.js";import{T as I}from"./Toast-D5AN34u6.js";import{c as r}from"./index-prwnWlNO.js";import"./charts-USIkmnH5.js";function G(){const[F,E]=t.useState([]),[x,L]=t.useState([]),[j,R]=t.useState([]),[c,N]=t.useState(null),[p,v]=t.useState([]),[g,_]=t.useState([]),[f,b]=t.useState(!0),[y,S]=t.useState(null),[n,m]=t.useState("model"),o=t.useRef(null),[l,i]=t.useState({account_id:"",node_id:"",model_id:"",from:"",to:"",limit:50}),q=t.useCallback((s,a="success")=>{o.current&&clearTimeout(o.current),S({message:s,type:a}),o.current=setTimeout(()=>S(null),2200)},[]);t.useEffect(()=>()=>{o.current&&clearTimeout(o.current)},[]);const D=async()=>{try{const s=await r.getAccounts();E(s)}catch(s){console.error("Failed to load accounts:",s)}},k=async s=>{try{const a=await r.getNodes(s);L(a)}catch(a){console.error("Failed to load nodes:",a)}},T=async()=>{b(!0);try{const s={...l};Object.keys(s).forEach(A=>{s[A]===""&&delete s[A]});const[a,u,$,O]=await Promise.all([r.getUsageSummary(s),r.getUsageSummary({...s,group_by:"model"}),r.getUsageSummary({...s,group_by:"node"}),r.getUsageLogs(s)]);Array.isArray(a)?N(a[0]||null):N(a),Array.isArray(u)?v(u):v([]),Array.isArray($)?_($):_([]),R(O.logs||[])}catch(s){q(s.message||"加载失败","error")}finally{b(!1)}};t.useEffect(()=>{D(),k()},[]),t.useEffect(()=>{k(l.account_id||void 0),l.node_id&&i(s=>({...s,node_id:""}))},[l.account_id]),t.useEffect(()=>{T()},[l]);const h=s=>s<.01?`$${s.toFixed(6)}`:s<1?`$${s.toFixed(4)}`:`$${s.toFixed(2)}`,d=s=>s>=1e6?`${(s/1e6).toFixed(2)}M`:s>=1e3?`${(s/1e3).toFixed(1)}K`:s.toString(),U=s=>new Date(s).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),C=s=>x.find(u=>u.id===s)?.name||s.slice(0,8);return e.jsxs("div",{className:"usage-page",children:[e.jsxs("div",{className:"usage-header",children:[e.jsx("h1",{children:"使用统计"}),e.jsx("p",{className:"sub",children:"查看 API 调用量和费用统计。"})]}),e.jsx(w,{className:"filter-card",children:e.jsxs("div",{className:"filters",children:[e.jsxs("label",{children:[e.jsx("span",{children:"账号"}),e.jsxs("select",{value:l.account_id||"",onChange:s=>i({...l,account_id:s.target.value}),children:[e.jsx("option",{value:"",children:"全部账号"}),F.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"节点"}),e.jsxs("select",{value:l.node_id||"",onChange:s=>i({...l,node_id:s.target.value}),children:[e.jsx("option",{value:"",children:"全部节点"}),x.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"开始时间"}),e.jsx("input",{type:"datetime-local",value:l.from||"",onChange:s=>i({...l,from:s.target.value?new Date(s.target.value).toISOString():""})})]}),e.jsxs("label",{children:[e.jsx("span",{children:"结束时间"}),e.jsx("input",{type:"datetime-local",value:l.to||"",onChange:s=>i({...l,to:s.target.value?new Date(s.target.value).toISOString():""})})]}),e.jsx("button",{className:"btn ghost",onClick:()=>i({limit:50}),children:"重置"}),e.jsx("button",{className:"btn primary",onClick:T,disabled:f,children:"刷新"})]})}),c&&e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:h(c.total_cost_usd)}),e.jsx("div",{className:"stat-label",children:"总费用"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:c.total_requests.toLocaleString()}),e.jsx("div",{className:"stat-label",children:"总请求数"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:d(c.total_input_tokens)}),e.jsx("div",{className:"stat-label",children:"输入 Token"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:d(c.total_output_tokens)}),e.jsx("div",{className:"stat-label",children:"输出 Token"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsxs("div",{className:"stat-value",children:[c.total_requests>0?(c.success_requests/c.total_requests*100).toFixed(1):0,"%"]}),e.jsx("div",{className:"stat-label",children:"成功率"})]})]}),e.jsxs("div",{className:"tabs",children:[e.jsx("button",{className:`tab ${n==="model"?"active":""}`,onClick:()=>m("model"),children:"按模型统计"}),e.jsx("button",{className:`tab ${n==="node"?"active":""}`,onClick:()=>m("node"),children:"按节点统计"}),e.jsx("button",{className:`tab ${n==="logs"?"active":""}`,onClick:()=>m("logs"),children:"详细记录"})]}),e.jsx(w,{children:f?e.jsx("div",{className:"loading-text",children:"加载中..."}):n==="model"?p.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用数据"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"模型"}),e.jsx("th",{children:"请求数"}),e.jsx("th",{children:"输入 Token"}),e.jsx("th",{children:"输出 Token"}),e.jsx("th",{children:"费用"})]})}),e.jsx("tbody",{children:p.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"model-cell",children:s.model_id||"未知"}),e.jsx("td",{children:s.total_requests.toLocaleString()}),e.jsx("td",{children:d(s.total_input_tokens)}),e.jsx("td",{children:d(s.total_output_tokens)}),e.jsx("td",{className:"cost-cell",children:h(s.total_cost_usd)})]},a))})]})}):n==="node"?g.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用数据"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"节点"}),e.jsx("th",{children:"请求数"}),e.jsx("th",{children:"输入 Token"}),e.jsx("th",{children:"输出 Token"}),e.jsx("th",{children:"费用"})]})}),e.jsx("tbody",{children:g.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"node-cell",children:C(s.node_id||"")}),e.jsx("td",{children:s.total_requests.toLocaleString()}),e.jsx("td",{children:d(s.total_input_tokens)}),e.jsx("td",{children:d(s.total_output_tokens)}),e.jsx("td",{className:"cost-cell",children:h(s.total_cost_usd)})]},a))})]})}):j.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用记录"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"时间"}),e.jsx("th",{children:"模型"}),e.jsx("th",{children:"节点"}),e.jsx("th",{children:"输入"}),e.jsx("th",{children:"输出"}),e.jsx("th",{children:"费用"}),e.jsx("th",{children:"状态"})]})}),e.jsx("tbody",{children:j.map(s=>e.jsxs("tr",{className:s.success?"":"failed",children:[e.jsx("td",{className:"time-cell",children:U(s.created_at)}),e.jsx("td",{className:"model-cell",children:s.model_id}),e.jsx("td",{children:C(s.node_id)}),e.jsx("td",{children:d(s.input_tokens)}),e.jsx("td",{children:d(s.output_tokens)}),e.jsx("td",{className:"cost-cell",children:h(s.cost_usd)}),e.jsx("td",{children:e.jsx("span",{className:`status-dot ${s.success?"success":"failed"}`})})]},s.id))})]})})}),e.jsx(I,{message:y?.message,type:y?.type})]})}export{G as default};
