import{r as a,j as e}from"./vendor-HVpYYIdB.js";import{C as F}from"./Card-B8iKcX7i.js";import{T as M}from"./Toast-D5AN34u6.js";import{c as r}from"./index-Cl6wuNBU.js";import"./charts-USIkmnH5.js";function J(){const[L,E]=a.useState([]),[j,R]=a.useState([]),[N,q]=a.useState([]),[c,p]=a.useState(null),[g,v]=a.useState([]),[f,_]=a.useState([]),[b,y]=a.useState(!0),[S,T]=a.useState(null),[o,m]=a.useState("model"),h=a.useRef(null),[l,d]=a.useState({account_id:"",node_id:"",model_id:"",from:"",to:"",limit:50}),U=a.useCallback((s,t="success")=>{h.current&&clearTimeout(h.current),T({message:s,type:t}),h.current=setTimeout(()=>T(null),2200)},[]);a.useEffect(()=>()=>{h.current&&clearTimeout(h.current)},[]);const O=async()=>{try{const s=await r.getAccounts();E(s)}catch(s){console.error("Failed to load accounts:",s)}},k=async s=>{try{const t=await r.getNodes(s);R(t)}catch(t){console.error("Failed to load nodes:",t)}},C=async()=>{y(!0);try{const s={...l};Object.keys(s).forEach(D=>{s[D]===""&&delete s[D]});const[t,n,x,z]=await Promise.all([r.getUsageSummary(s),r.getUsageSummary({...s,group_by:"model"}),r.getUsageSummary({...s,group_by:"node"}),r.getUsageLogs(s)]);Array.isArray(t)?p(t[0]||null):p(t),Array.isArray(n)?v(n):v([]),Array.isArray(x)?_(x):_([]),q(z.logs||[])}catch(s){U(s.message||"加载失败","error")}finally{y(!1)}};a.useEffect(()=>{O(),k()},[]),a.useEffect(()=>{k(l.account_id||void 0),l.node_id&&d(s=>({...s,node_id:""}))},[l.account_id]),a.useEffect(()=>{C()},[l]);const u=s=>s<.01?`$${s.toFixed(6)}`:s<1?`$${s.toFixed(4)}`:`$${s.toFixed(2)}`,i=s=>s>=1e6?`${(s/1e6).toFixed(2)}M`:s>=1e3?`${(s/1e3).toFixed(1)}K`:s.toString(),I=s=>new Date(s).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),$=s=>{if(!s)return"";const t=new Date(s),n=t.getTimezoneOffset();return new Date(t.getTime()-n*60*1e3).toISOString().slice(0,16)},w=s=>s?new Date(s).toISOString():"",A=s=>j.find(n=>n.id===s)?.name||s.slice(0,8);return e.jsxs("div",{className:"usage-page",children:[e.jsxs("div",{className:"usage-header",children:[e.jsx("h1",{children:"使用统计"}),e.jsx("p",{className:"sub",children:"查看 API 调用量和费用统计。"})]}),e.jsx(F,{className:"filter-card",children:e.jsxs("div",{className:"filters",children:[e.jsxs("label",{children:[e.jsx("span",{children:"账号"}),e.jsxs("select",{value:l.account_id||"",onChange:s=>d({...l,account_id:s.target.value}),children:[e.jsx("option",{value:"",children:"全部账号"}),L.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"节点"}),e.jsxs("select",{value:l.node_id||"",onChange:s=>d({...l,node_id:s.target.value}),children:[e.jsx("option",{value:"",children:"全部节点"}),j.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"开始时间"}),e.jsx("input",{type:"datetime-local",value:$(l.from||""),onChange:s=>d({...l,from:w(s.target.value)})})]}),e.jsxs("label",{children:[e.jsx("span",{children:"结束时间"}),e.jsx("input",{type:"datetime-local",value:$(l.to||""),onChange:s=>d({...l,to:w(s.target.value)})})]}),e.jsx("button",{className:"btn ghost",onClick:()=>d({limit:50}),children:"重置"}),e.jsx("button",{className:"btn primary",onClick:C,disabled:b,children:"刷新"})]})}),c&&e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:u(c.total_cost_usd)}),e.jsx("div",{className:"stat-label",children:"总费用"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:c.total_requests.toLocaleString()}),e.jsx("div",{className:"stat-label",children:"总请求数"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:i(c.total_input_tokens)}),e.jsx("div",{className:"stat-label",children:"输入 Token"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:i(c.total_output_tokens)}),e.jsx("div",{className:"stat-label",children:"输出 Token"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsxs("div",{className:"stat-value",children:[c.total_requests>0?(c.success_requests/c.total_requests*100).toFixed(1):0,"%"]}),e.jsx("div",{className:"stat-label",children:"成功率"})]})]}),e.jsxs("div",{className:"tabs",children:[e.jsx("button",{className:`tab ${o==="model"?"active":""}`,onClick:()=>m("model"),children:"按模型统计"}),e.jsx("button",{className:`tab ${o==="node"?"active":""}`,onClick:()=>m("node"),children:"按节点统计"}),e.jsx("button",{className:`tab ${o==="logs"?"active":""}`,onClick:()=>m("logs"),children:"详细记录"})]}),e.jsx(F,{children:b?e.jsx("div",{className:"loading-text",children:"加载中..."}):o==="model"?g.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用数据"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"模型"}),e.jsx("th",{children:"请求数"}),e.jsx("th",{children:"输入 Token"}),e.jsx("th",{children:"输出 Token"}),e.jsx("th",{children:"费用"})]})}),e.jsx("tbody",{children:g.map((s,t)=>e.jsxs("tr",{children:[e.jsx("td",{className:"model-cell",children:s.model_id||"未知"}),e.jsx("td",{children:s.total_requests.toLocaleString()}),e.jsx("td",{children:i(s.total_input_tokens)}),e.jsx("td",{children:i(s.total_output_tokens)}),e.jsx("td",{className:"cost-cell",children:u(s.total_cost_usd)})]},t))})]})}):o==="node"?f.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用数据"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"节点"}),e.jsx("th",{children:"请求数"}),e.jsx("th",{children:"输入 Token"}),e.jsx("th",{children:"输出 Token"}),e.jsx("th",{children:"费用"})]})}),e.jsx("tbody",{children:f.map((s,t)=>e.jsxs("tr",{children:[e.jsx("td",{className:"node-cell",children:A(s.node_id||"")}),e.jsx("td",{children:s.total_requests.toLocaleString()}),e.jsx("td",{children:i(s.total_input_tokens)}),e.jsx("td",{children:i(s.total_output_tokens)}),e.jsx("td",{className:"cost-cell",children:u(s.total_cost_usd)})]},t))})]})}):N.length===0?e.jsx("div",{className:"empty-text",children:"暂无使用记录"}):e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"usage-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"时间"}),e.jsx("th",{children:"模型"}),e.jsx("th",{children:"节点"}),e.jsx("th",{children:"输入"}),e.jsx("th",{children:"输出"}),e.jsx("th",{children:"费用"}),e.jsx("th",{children:"状态"})]})}),e.jsx("tbody",{children:N.map(s=>e.jsxs("tr",{className:s.success?"":"failed",children:[e.jsx("td",{className:"time-cell",children:I(s.created_at)}),e.jsx("td",{className:"model-cell",children:s.model_id}),e.jsx("td",{children:A(s.node_id)}),e.jsx("td",{children:i(s.input_tokens)}),e.jsx("td",{children:i(s.output_tokens)}),e.jsx("td",{className:"cost-cell",children:u(s.cost_usd)}),e.jsx("td",{children:e.jsx("span",{className:`status-dot ${s.success?"success":"failed"}`})})]},s.id))})]})})}),e.jsx(M,{message:S?.message,type:S?.type})]})}export{J as default};
