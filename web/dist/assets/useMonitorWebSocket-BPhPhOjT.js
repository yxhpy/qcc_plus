import{r as s,j as e,m as U}from"./vendor-HVpYYIdB.js";import{r as z,d as B}from"./index-JckuGpfa.js";import{p as T,f as H}from"./date-DeDlRUHn.js";const W={"24h":1440*60*1e3},G=60*1e3,O=new Map,F=new Map;function J(t,r,l,d){return[t,r,l||"",d||""].join("__")}async function K(t,r,l,d,p){const b=new Date,c=b.toISOString(),m=new Date(b.getTime()-W[r]).toISOString(),a=new URLSearchParams;a.set("from",m),a.set("to",c),l&&a.set("share_token",l),d&&a.set("source",d);const o=a.toString(),x=o?`/api/nodes/${encodeURIComponent(t)}/health-history?${o}`:`/api/nodes/${encodeURIComponent(t)}/health-history`;return z(x,{signal:p})}function V(t,r){return{node_id:r.node_id||t,check_time:r.check_time,success:r.success,response_time_ms:typeof r.response_time_ms=="number"?r.response_time_ms:0,error_message:r.error_message||"",check_method:r.check_method||"api"}}function X({nodeId:t,refreshKey:r=0,latest:l,shareToken:d,source:p=""}){const[c,m]=s.useState(null),[a,o]=s.useState(!1),[x,k]=s.useState(null),[j,S]=s.useState(null),N=s.useRef(null),v=s.useRef(r),_=s.useRef(!0),i=s.useMemo(()=>J(t,"24h",d,p),[t,"24h",d,p]),R=s.useCallback(async(n=!1)=>{const f=Date.now(),g=n?void 0:O.get(i);if(g&&f-g.ts<G){m(g.data),o(!1);return}if(!n){const u=F.get(i);if(u){o(!0);try{const D=await u.promise;if(!_.current||u.controller.signal.aborted)return;m(D)}catch(D){if(u.controller.signal.aborted)return;k(D.message||"加载失败")}finally{u.controller.signal.aborted||o(!1)}return}}N.current&&N.current.abort();const h=new AbortController;N.current=h,o(!0),k(null);const y=K(t,"24h",d,p,h.signal).then(u=>(O.set(i,{data:u,ts:Date.now()}),u)).finally(()=>{F.get(i)?.controller===h&&F.delete(i)});F.set(i,{controller:h,promise:y});try{const u=await y;!h.signal.aborted&&_.current&&m(u)}catch(u){if(h.signal.aborted)return;k(u.message||"加载失败")}finally{h.signal.aborted||o(!1)}},[i,t,"24h",d,p]);s.useEffect(()=>(_.current=!0,()=>{_.current=!1,N.current&&N.current.abort()}),[]),s.useEffect(()=>{const n=r!==v.current;v.current=r,R(n)},[R,r]),s.useEffect(()=>{!l||l.node_id!==t||m(n=>{const f=V(t,l),g=T(f.check_time)?.getTime()||Date.now(),h=Date.now()-W["24h"];if(!n)return{node_id:t,from:new Date(h).toISOString(),to:new Date(g).toISOString(),total:1,checks:[f]};if(n.checks.some(L=>L.check_time===f.check_time))return n;const u=[...n.checks,f];u.sort((L,q)=>{const A=T(L.check_time)?.getTime()||0,P=T(q.check_time)?.getTime()||0;return A-P});const D=u.filter(L=>(T(L.check_time)?.getTime()||0)>=h);return{...n,to:new Date(Math.max(T(n.to)?.getTime()||0,g)).toISOString(),total:n.total+1,checks:D}})},[l,t,"24h"]);const E=s.useMemo(()=>{const f=(c?.checks||[]).reduce((y,u)=>(u.success?y.ok+=1:y.fail+=1,y),{ok:0,fail:0}),g=f.ok+f.fail,h=g>0?(f.ok/g*100).toFixed(1):null;return{...f,healthRate:h}},[c]),M=()=>{if(!j)return null;const{rec:n,x:f,y:g}=j,h=n.success?"在线":"离线",y=e.jsxs("div",{className:"health-tooltip",style:{left:f+12,top:g-10},children:[e.jsx("div",{className:"health-tooltip__time",children:H(n.check_time)}),e.jsxs("div",{className:"health-tooltip__row",children:["状态：",h]}),e.jsxs("div",{className:"health-tooltip__row",children:["耗时：",n.response_time_ms||0," ms"]}),e.jsxs("div",{className:"health-tooltip__row",children:["方式：",n.check_method||"api"]}),n.error_message&&e.jsxs("div",{className:"health-tooltip__row",children:["错误：",n.error_message]})]});return typeof document>"u"?y:U.createPortal(y,document.body)},C=c?.checks||[],w=C.length>0?C[C.length-1]:null,$=w?w.success:!1;return e.jsxs("div",{className:"health-timeline health-timeline--compact",children:[e.jsx("div",{className:"health-timeline__header",children:e.jsxs("div",{className:"health-timeline__status",children:[e.jsx("span",{className:`status-dot ${$?"online":"offline"}`}),e.jsx("span",{className:`status-text ${$?"online":"offline"}`,children:$?"在线":"离线"}),E.healthRate!==null&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"sep",children:"·"}),e.jsxs("span",{className:"health-rate",children:["24h健康率 ",e.jsxs("strong",{children:[E.healthRate,"%"]})]})]})]})}),e.jsxs("div",{className:`health-track ${a?"loading":""}`,children:[a&&e.jsx("div",{className:"health-track__skeleton"}),!a&&C.length===0&&e.jsx("div",{className:"health-empty",children:"暂无数据"}),!a&&C.map((n,f)=>{const g=n.success?"ok":"fail";return e.jsx("div",{className:`health-dot ${g}`,onMouseEnter:h=>S({rec:n,x:h.clientX,y:h.clientY}),onMouseLeave:()=>S(null),title:H(n.check_time)},`${n.check_time}-${f}`)})]}),x&&e.jsx("div",{className:"health-error",children:x}),M()]})}function Y({content:t,children:r,trigger:l="both",maxWidth:d="300px",position:p="top"}){const[b,c]=s.useState(!1),[m,a]=s.useState(!1),o=s.useRef(null),x=l==="hover"||l==="both",k=l==="click"||l==="both";if(!(t!=null&&t!==!1&&!(typeof t=="string"&&t.trim()==="")))return e.jsx(e.Fragment,{children:r});const S=()=>{x&&c(!0)},N=()=>{x&&(m||c(!1))},v=()=>{k&&c(i=>{const R=!i;return a(R),R})};s.useEffect(()=>{if(!b)return;const i=R=>{o.current&&(o.current.contains(R.target)||(c(!1),a(!1)))};return document.addEventListener("mousedown",i),document.addEventListener("touchstart",i),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("touchstart",i)}},[b]);const _=`tooltip-${p}`;return e.jsxs("div",{className:"tooltip-wrapper",ref:o,onMouseEnter:S,onMouseLeave:N,onClick:v,children:[r,e.jsxs("div",{className:`tooltip-content ${_} ${b?"show":""}`,style:{maxWidth:d},role:"tooltip",children:[t,e.jsx("span",{className:"tooltip-arrow"})]})]})}function ee({node:t,historyRefreshKey:r,healthEvent:l,shareToken:d}){const{preference:p}=B(),b=Number(t.traffic?.success_rate??0),c=Number(t.traffic?.avg_response_time??0),m=Number(t.traffic?.total_requests??0),a=Number(t.traffic?.failed_requests??0),o=(t.last_error||t.health?.last_ping_err||"").trim(),x={up:"在线",down:"离线"},j=(t.health?.status||"down")==="up"?"up":"down",S=(t.health?.check_method||"api").toUpperCase(),N=Number(t.health?.last_ping_ms??0),v=t.health?.last_check_at?t.health.last_check_at.replace(/^\d{4}年\d{2}月\d{2}日\s*/,""):"--",_=t.circuit_open?"node-card node-card--circuit-open":t.is_active?"node-card node-card--active":"node-card";return e.jsxs("div",{className:_,children:[o&&e.jsx("div",{className:"node-card__error-badge",children:e.jsx(Y,{content:o,trigger:"both",maxWidth:"300px",children:e.jsx("span",{className:"node-card__error-icon",role:"img","aria-label":"错误",children:"⚠️"})})}),e.jsx("div",{className:"node-card__header",children:e.jsxs("div",{className:"node-card__title-wrap",children:[e.jsx("div",{className:"node-card__title",children:t.name||"未命名节点"}),e.jsx("div",{className:"node-card__url",children:t.url||"-"})]})}),e.jsxs("div",{className:"node-card__metrics-compact",children:[p.showProxy&&e.jsxs("div",{className:"metrics-row traffic",children:[e.jsx("span",{className:"row-label",children:"代理"}),e.jsxs("span",{className:"metric",children:["成功率 ",e.jsxs("strong",{children:[b.toFixed(1),"%"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["延时 ",e.jsxs("strong",{children:[c||"--","ms"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["请求 ",e.jsx("strong",{children:m.toLocaleString()})]}),e.jsxs("span",{className:"metric secondary",children:["/失败 ",e.jsx("strong",{className:a>0?"danger":"",children:a.toLocaleString()})]})]}),p.showHealth&&e.jsxs("div",{className:"metrics-row health",children:[e.jsx("span",{className:"row-label",children:"探活"}),e.jsx("span",{className:`metric health-${j}`,children:e.jsx("strong",{children:x[j]})}),e.jsx("span",{className:"sep",children:"|"}),e.jsx("span",{className:"metric",children:e.jsxs("strong",{children:[N||"--","ms"]})}),e.jsxs("span",{className:"metric secondary",children:["(",S,")"]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric secondary",children:["检查于 ",v]})]})]}),e.jsx(X,{nodeId:t.id,refreshKey:r,latest:l,shareToken:d}),e.jsx("div",{className:"node-card__footer",children:e.jsxs("div",{className:"node-card__badges",children:[t.circuit_open&&e.jsx("span",{className:"badge badge-warning",children:"熔断中"}),t.is_active&&!t.circuit_open&&e.jsx("span",{className:"badge badge-primary",children:"使用中"}),t.disabled&&e.jsx("span",{className:"badge badge-muted",children:"已停用"})]})})]})}function te(t,r){const[l,d]=s.useState(!1),[p,b]=s.useState(null),c=s.useRef(null),m=s.useRef(null),a=s.useRef(0),o=s.useRef(!0),x=s.useRef(()=>{}),k=s.useRef(null),j=s.useRef(null),S=s.useCallback(()=>{k.current&&(b(k.current),k.current=null),j.current=null},[]),N=s.useCallback(()=>{j.current===null&&(j.current=window.requestAnimationFrame(S))},[S]),v=s.useCallback(()=>{if(!o.current)return;m.current&&clearTimeout(m.current);const i=a.current,M=Math.min(3e4,1e3*2**i),C=M*.3*Math.random(),w=M+C;m.current=setTimeout(()=>{a.current+=1,x.current()},w)},[]),_=s.useCallback(()=>{const i=window.location.protocol==="https:"?"wss:":"ws:",R=window.location.host,E=new URLSearchParams;t&&E.set("account_id",t),r&&E.set("token",r);const M=E.toString(),C=`${i}//${R}/api/monitor/ws${M?`?${M}`:""}`;try{c.current&&c.current.close();const w=new WebSocket(C);w.onopen=()=>{a.current=0,d(!0)},w.onmessage=$=>{try{const n=JSON.parse($.data);k.current=n,N()}catch(n){console.error("[WS] Failed to parse message:",n)}},w.onerror=$=>{console.error("[WS] Error:",$)},w.onclose=()=>{d(!1),c.current=null,v()},c.current=w}catch(w){console.error("[WS] Failed to connect:",w),v()}},[t,N,v,r]);return s.useEffect(()=>{x.current=_},[_]),s.useEffect(()=>(o.current=!0,_(),()=>{o.current=!1,m.current&&clearTimeout(m.current),j.current!==null&&cancelAnimationFrame(j.current),c.current&&c.current.close()}),[_]),{connected:l,lastMessage:p}}export{ee as N,te as u};
