import{r as s,j as e}from"./vendor-HVpYYIdB.js";import{r as O,d as W}from"./index-qk43s-9n.js";import{p as M}from"./date-DeDlRUHn.js";const $={"24h":1440*60*1e3},q=60*1e3,L=new Map,D=new Map;function A(t,n,l,u){return[t,n,l||"",u||""].join("__")}async function P(t,n,l,u,_){const b=new Date,c=b.toISOString(),h=new Date(b.getTime()-$[n]).toISOString(),r=new URLSearchParams;r.set("from",h),r.set("to",c),l&&r.set("share_token",l),u&&r.set("source",u);const d=r.toString(),x=d?`/api/nodes/${encodeURIComponent(t)}/health-history?${d}`:`/api/nodes/${encodeURIComponent(t)}/health-history`;return O(x,{signal:_})}function U(t,n){return{node_id:n.node_id||t,check_time:n.check_time,success:n.success,response_time_ms:typeof n.response_time_ms=="number"?n.response_time_ms:0,error_message:n.error_message||"",check_method:n.check_method||"api"}}function z({nodeId:t,refreshKey:n=0,latest:l,shareToken:u,source:_=""}){const[c,h]=s.useState(null),[,r]=s.useState(!1),[d,x]=s.useState(null),j=s.useRef(null),N=s.useRef(n),w=s.useRef(!0),p=s.useMemo(()=>A(t,"24h",u,_),[t,"24h",u,_]),S=s.useCallback(async(a=!1)=>{const f=Date.now(),o=a?void 0:L.get(p);if(o&&f-o.ts<q){h(o.data),r(!1);return}if(!a){const i=D.get(p);if(i){r(!0);try{const C=await i.promise;if(!w.current||i.controller.signal.aborted)return;h(C)}catch(C){if(i.controller.signal.aborted)return;x(C.message||"加载失败")}finally{i.controller.signal.aborted||r(!1)}return}}j.current&&j.current.abort();const m=new AbortController;j.current=m,r(!0),x(null);const R=P(t,"24h",u,_,m.signal).then(i=>(L.set(p,{data:i,ts:Date.now()}),i)).finally(()=>{D.get(p)?.controller===m&&D.delete(p)});D.set(p,{controller:m,promise:R});try{const i=await R;!m.signal.aborted&&w.current&&h(i)}catch(i){if(m.signal.aborted)return;x(i.message||"加载失败")}finally{m.signal.aborted||r(!1)}},[p,t,"24h",u,_]);s.useEffect(()=>(w.current=!0,()=>{w.current=!1,j.current&&j.current.abort()}),[]),s.useEffect(()=>{const a=n!==N.current;N.current=n,S(a)},[S,n]),s.useEffect(()=>{!l||l.node_id!==t||h(a=>{const f=U(t,l),o=M(f.check_time)?.getTime()||Date.now(),m=Date.now()-$["24h"];if(!a)return{node_id:t,from:new Date(m).toISOString(),to:new Date(o).toISOString(),total:1,checks:[f]};if(a.checks.some(E=>E.check_time===f.check_time))return a;const i=[...a.checks,f];i.sort((E,T)=>{const F=M(E.check_time)?.getTime()||0,H=M(T.check_time)?.getTime()||0;return F-H});const C=i.filter(E=>(M(E.check_time)?.getTime()||0)>=m);return{...a,to:new Date(Math.max(M(a.to)?.getTime()||0,o)).toISOString(),total:a.total+1,checks:C}})},[l,t,"24h"]);const k=s.useMemo(()=>{const f=(c?.checks||[]).reduce((R,i)=>(i.success?R.ok+=1:R.fail+=1,R),{ok:0,fail:0}),o=f.ok+f.fail,m=o>0?(f.ok/o*100).toFixed(1):null;return{...f,healthRate:m}},[c]),g=c?.checks||[],y=g.length>0?g[g.length-1]:null,v=y?y.success:!1;return e.jsxs("div",{className:"health-timeline health-timeline--compact",children:[e.jsx("div",{className:"health-timeline__header",children:e.jsxs("div",{className:"health-timeline__status",children:[e.jsx("span",{className:`status-dot ${v?"online":"offline"}`}),e.jsx("span",{className:`status-text ${v?"online":"offline"}`,children:v?"在线":"离线"}),k.healthRate!==null&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"sep",children:"·"}),e.jsxs("span",{className:"health-rate",children:["24h健康率 ",e.jsxs("strong",{children:[k.healthRate,"%"]})]})]})]})}),d&&e.jsx("div",{className:"health-error",children:d})]})}function G({content:t,children:n,trigger:l="both",maxWidth:u="300px",position:_="top"}){const[b,c]=s.useState(!1),[h,r]=s.useState(!1),d=s.useRef(null),x=l==="hover"||l==="both",j=l==="click"||l==="both";if(!(t!=null&&t!==!1&&!(typeof t=="string"&&t.trim()==="")))return e.jsx(e.Fragment,{children:n});const w=()=>{x&&c(!0)},p=()=>{x&&(h||c(!1))},S=()=>{j&&c(g=>{const y=!g;return r(y),y})};s.useEffect(()=>{if(!b)return;const g=y=>{d.current&&(d.current.contains(y.target)||(c(!1),r(!1)))};return document.addEventListener("mousedown",g),document.addEventListener("touchstart",g),()=>{document.removeEventListener("mousedown",g),document.removeEventListener("touchstart",g)}},[b]);const k=`tooltip-${_}`;return e.jsxs("div",{className:"tooltip-wrapper",ref:d,onMouseEnter:w,onMouseLeave:p,onClick:S,children:[n,e.jsxs("div",{className:`tooltip-content ${k} ${b?"show":""}`,style:{maxWidth:u},role:"tooltip",children:[t,e.jsx("span",{className:"tooltip-arrow"})]})]})}function B({node:t,historyRefreshKey:n,healthEvent:l,shareToken:u}){const{preference:_}=W(),b=Number(t.traffic?.success_rate??0),c=Number(t.traffic?.avg_response_time??0),h=Number(t.traffic?.total_requests??0),r=Number(t.traffic?.failed_requests??0),d=(t.last_error||t.health?.last_ping_err||"").trim(),x={up:"在线",down:"离线"},N=(t.health?.status||"down")==="up"?"up":"down",w=(t.health?.check_method||"api").toUpperCase(),p=Number(t.health?.last_ping_ms??0),S=t.health?.last_check_at?t.health.last_check_at.replace(/^\d{4}年\d{2}月\d{2}日\s*/,""):"--",k=t.circuit_open?"node-card node-card--circuit-open":t.is_active?"node-card node-card--active":"node-card";return e.jsxs("div",{className:k,children:[d&&e.jsx("div",{className:"node-card__error-badge",children:e.jsx(G,{content:d,trigger:"both",maxWidth:"300px",children:e.jsx("span",{className:"node-card__error-icon",role:"img","aria-label":"错误",children:"⚠️"})})}),e.jsx("div",{className:"node-card__header",children:e.jsxs("div",{className:"node-card__title-wrap",children:[e.jsx("div",{className:"node-card__title",children:t.name||"未命名节点"}),e.jsx("div",{className:"node-card__url",children:t.url||"-"})]})}),e.jsxs("div",{className:"node-card__metrics-compact",children:[_.showProxy&&e.jsxs("div",{className:"metrics-row traffic",children:[e.jsx("span",{className:"row-label",children:"代理"}),e.jsxs("span",{className:"metric",children:["成功率 ",e.jsxs("strong",{children:[b.toFixed(1),"%"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["延时 ",e.jsxs("strong",{children:[c||"--","ms"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["请求 ",e.jsx("strong",{children:h.toLocaleString()})]}),e.jsxs("span",{className:"metric secondary",children:["/失败 ",e.jsx("strong",{className:r>0?"danger":"",children:r.toLocaleString()})]})]}),_.showHealth&&e.jsxs("div",{className:"metrics-row health",children:[e.jsx("span",{className:"row-label",children:"探活"}),e.jsx("span",{className:`metric health-${N}`,children:e.jsx("strong",{children:x[N]})}),e.jsx("span",{className:"sep",children:"|"}),e.jsx("span",{className:"metric",children:e.jsxs("strong",{children:[p||"--","ms"]})}),e.jsxs("span",{className:"metric secondary",children:["(",w,")"]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric secondary",children:["检查于 ",S]})]})]}),e.jsx(z,{nodeId:t.id,refreshKey:n,latest:l,shareToken:u}),e.jsx("div",{className:"node-card__footer",children:e.jsxs("div",{className:"node-card__badges",children:[t.circuit_open&&e.jsx("span",{className:"badge badge-warning",children:"熔断中"}),t.is_active&&!t.circuit_open&&e.jsx("span",{className:"badge badge-primary",children:"使用中"}),t.disabled&&e.jsx("span",{className:"badge badge-muted",children:"已停用"})]})})]})}function I(t,n){const[l,u]=s.useState(!1),[_,b]=s.useState(null),c=s.useRef(null),h=s.useRef(null),r=s.useRef(0),d=s.useRef(!0),x=s.useRef(()=>{}),j=s.useRef(null),N=s.useRef(null),w=s.useCallback(()=>{j.current&&(b(j.current),j.current=null),N.current=null},[]),p=s.useCallback(()=>{N.current===null&&(N.current=window.requestAnimationFrame(w))},[w]),S=s.useCallback(()=>{if(!d.current)return;h.current&&clearTimeout(h.current);const g=r.current,a=Math.min(3e4,1e3*2**g),f=a*.3*Math.random(),o=a+f;h.current=setTimeout(()=>{r.current+=1,x.current()},o)},[]),k=s.useCallback(()=>{const g=window.location.protocol==="https:"?"wss:":"ws:",y=window.location.host,v=new URLSearchParams;t&&v.set("account_id",t),n&&v.set("token",n);const a=v.toString(),f=`${g}//${y}/api/monitor/ws${a?`?${a}`:""}`;try{c.current&&c.current.close();const o=new WebSocket(f);o.onopen=()=>{r.current=0,u(!0)},o.onmessage=m=>{try{const R=JSON.parse(m.data);j.current=R,p()}catch(R){console.error("[WS] Failed to parse message:",R)}},o.onerror=m=>{console.error("[WS] Error:",m)},o.onclose=()=>{u(!1),c.current=null,S()},c.current=o}catch(o){console.error("[WS] Failed to connect:",o),S()}},[t,p,S,n]);return s.useEffect(()=>{x.current=k},[k]),s.useEffect(()=>(d.current=!0,k(),()=>{d.current=!1,h.current&&clearTimeout(h.current),N.current!==null&&cancelAnimationFrame(N.current),c.current&&c.current.close()}),[k]),{connected:l,lastMessage:_}}export{B as N,I as u};
