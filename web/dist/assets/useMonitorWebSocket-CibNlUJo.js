import{r as s,j as e,m as U}from"./vendor-HVpYYIdB.js";import{r as z,d as B}from"./index-CYZBUAqw.js";import{p as D,f as O}from"./date-DeDlRUHn.js";const q={"24h":1440*60*1e3},G=60*1e3,W=new Map,L=new Map;function J(t,n,l,m){return[t,n,l||"",m||""].join("__")}async function K(t,n,l,m,x){const w=new Date,a=w.toISOString(),f=new Date(w.getTime()-q[n]).toISOString(),c=new URLSearchParams;c.set("from",f),c.set("to",a),l&&c.set("share_token",l),m&&c.set("source",m);const o=c.toString(),j=o?`/api/nodes/${encodeURIComponent(t)}/health-history?${o}`:`/api/nodes/${encodeURIComponent(t)}/health-history`;return z(j,{signal:x})}function V(t,n){return{node_id:n.node_id||t,check_time:n.check_time,success:n.success,response_time_ms:typeof n.response_time_ms=="number"?n.response_time_ms:0,error_message:n.error_message||"",check_method:n.check_method||"api"}}function X({nodeId:t,refreshKey:n=0,latest:l,shareToken:m,source:x=""}){const[a,f]=s.useState(null),[c,o]=s.useState(!1),[j,v]=s.useState(null),[b,y]=s.useState(null),N=s.useRef(null),k=s.useRef(n),_=s.useRef(!0),i=s.useMemo(()=>J(t,"24h",m,x),[t,"24h",m,x]),u=s.useCallback(async(r=!1)=>{const p=Date.now(),g=r?void 0:W.get(i);if(g&&p-g.ts<G){f(g.data),o(!1);return}if(!r){const h=L.get(i);if(h){o(!0);try{const M=await h.promise;if(!_.current||h.controller.signal.aborted)return;f(M)}catch(M){if(h.controller.signal.aborted)return;v(M.message||"加载失败")}finally{h.controller.signal.aborted||o(!1)}return}}N.current&&N.current.abort();const d=new AbortController;N.current=d,o(!0),v(null);const S=K(t,"24h",m,x,d.signal).then(h=>(W.set(i,{data:h,ts:Date.now()}),h)).finally(()=>{L.get(i)?.controller===d&&L.delete(i)});L.set(i,{controller:d,promise:S});try{const h=await S;!d.signal.aborted&&_.current&&f(h)}catch(h){if(d.signal.aborted)return;v(h.message||"加载失败")}finally{d.signal.aborted||o(!1)}},[i,t,"24h",m,x]);s.useEffect(()=>(_.current=!0,()=>{_.current=!1,N.current&&N.current.abort()}),[]),s.useEffect(()=>{const r=n!==k.current;k.current=n,u(r)},[u,n]),s.useEffect(()=>{!l||l.node_id!==t||f(r=>{const p=V(t,l),g=D(p.check_time)?.getTime()||Date.now(),d=Date.now()-q["24h"];if(!r)return{node_id:t,from:new Date(d).toISOString(),to:new Date(g).toISOString(),total:1,checks:[p]};if(r.checks.some($=>$.check_time===p.check_time))return r;const h=[...r.checks,p];h.sort(($,F)=>{const A=D($.check_time)?.getTime()||0,P=D(F.check_time)?.getTime()||0;return A-P});const M=h.filter($=>(D($.check_time)?.getTime()||0)>=d);return{...r,to:new Date(Math.max(D(r.to)?.getTime()||0,g)).toISOString(),total:r.total+1,checks:M}})},[l,t,"24h"]);const R=s.useMemo(()=>{const p=(a?.checks||[]).reduce((S,h)=>(h.success?S.ok+=1:S.fail+=1,S),{ok:0,fail:0}),g=p.ok+p.fail,d=g>0?(p.ok/g*100).toFixed(1):null;return{...p,healthRate:d}},[a]),C=()=>{if(!b)return null;const{rec:r,x:p,y:g}=b,d=r.success?"在线":"离线",S=e.jsxs("div",{className:"health-tooltip",style:{left:p+12,top:g-10},children:[e.jsx("div",{className:"health-tooltip__time",children:O(r.check_time)}),e.jsxs("div",{className:"health-tooltip__row",children:["状态：",d]}),e.jsxs("div",{className:"health-tooltip__row",children:["耗时：",r.response_time_ms||0," ms"]}),e.jsxs("div",{className:"health-tooltip__row",children:["方式：",r.check_method||"api"]}),r.error_message&&e.jsxs("div",{className:"health-tooltip__row",children:["错误：",r.error_message]})]});return typeof document>"u"?S:U.createPortal(S,document.body)},E=a?.checks||[],H=E.length>0?E[E.length-1]:null,T=H?H.success:!1;return e.jsxs("div",{className:"health-timeline health-timeline--compact",children:[e.jsx("div",{className:"health-timeline__header",children:e.jsxs("div",{className:"health-timeline__status",children:[e.jsx("span",{className:`status-dot ${T?"online":"offline"}`}),e.jsx("span",{className:`status-text ${T?"online":"offline"}`,children:T?"在线":"离线"}),R.healthRate!==null&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"sep",children:"·"}),e.jsxs("span",{className:"health-rate",children:["24h健康率 ",e.jsxs("strong",{children:[R.healthRate,"%"]})]})]})]})}),e.jsxs("div",{className:`health-track ${c?"loading":""}`,children:[c&&e.jsx("div",{className:"health-track__skeleton"}),!c&&E.length===0&&e.jsx("div",{className:"health-empty",children:"暂无数据"}),!c&&E.map((r,p)=>{const g=r.success?"ok":"fail";return e.jsx("div",{className:`health-dot ${g}`,onMouseEnter:d=>y({rec:r,x:d.clientX,y:d.clientY}),onMouseLeave:()=>y(null),title:O(r.check_time)},`${r.check_time}-${p}`)})]}),j&&e.jsx("div",{className:"health-error",children:j}),C()]})}function Y({content:t,children:n,trigger:l="both",maxWidth:m="300px",position:x="top"}){const[w,a]=s.useState(!1),[f,c]=s.useState(!1),o=s.useRef(null),j=l==="hover"||l==="both",v=l==="click"||l==="both";if(!(t!=null&&t!==!1&&!(typeof t=="string"&&t.trim()==="")))return e.jsx(e.Fragment,{children:n});const y=()=>{j&&a(!0)},N=()=>{j&&(f||a(!1))},k=()=>{v&&a(i=>{const u=!i;return c(u),u})};s.useEffect(()=>{if(!w)return;const i=u=>{o.current&&(o.current.contains(u.target)||(a(!1),c(!1)))};return document.addEventListener("mousedown",i),document.addEventListener("touchstart",i),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("touchstart",i)}},[w]);const _=`tooltip-${x}`;return e.jsxs("div",{className:"tooltip-wrapper",ref:o,onMouseEnter:y,onMouseLeave:N,onClick:k,children:[n,e.jsxs("div",{className:`tooltip-content ${_} ${w?"show":""}`,style:{maxWidth:m},role:"tooltip",children:[t,e.jsx("span",{className:"tooltip-arrow"})]})]})}function ee({node:t,historyRefreshKey:n,healthEvent:l,shareToken:m}){const{preference:x}=B(),w=Number(t.traffic?.success_rate??0),a=Number(t.traffic?.avg_response_time??0),f=Number(t.traffic?.total_requests??0),c=Number(t.traffic?.failed_requests??0),o=(t.last_error||t.health?.last_ping_err||"").trim(),j={up:"在线",down:"离线"},b=(t.health?.status||"down")==="up"?"up":"down",y=(t.health?.check_method||"api").toUpperCase(),N=Number(t.health?.last_ping_ms??0),k=t.health?.last_check_at?t.health.last_check_at.replace(/^\d{4}年\d{2}月\d{2}日\s*/,""):"--",_=t.circuit_open?"node-card node-card--circuit-open":t.is_active?"node-card node-card--active":"node-card";return e.jsxs("div",{className:_,children:[o&&e.jsx("div",{className:"node-card__error-badge",children:e.jsx(Y,{content:o,trigger:"both",maxWidth:"300px",children:e.jsx("span",{className:"node-card__error-icon",role:"img","aria-label":"错误",children:"⚠️"})})}),e.jsx("div",{className:"node-card__header",children:e.jsxs("div",{className:"node-card__title-wrap",children:[e.jsx("div",{className:"node-card__title",children:t.name||"未命名节点"}),e.jsx("div",{className:"node-card__url",children:t.url||"-"})]})}),e.jsxs("div",{className:"node-card__metrics-compact",children:[x.showProxy&&e.jsxs("div",{className:"metrics-row traffic",children:[e.jsx("span",{className:"row-label",children:"代理"}),e.jsxs("span",{className:"metric",children:["成功率 ",e.jsxs("strong",{children:[w.toFixed(1),"%"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["延时 ",e.jsxs("strong",{children:[a||"--","ms"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["请求 ",e.jsx("strong",{children:f.toLocaleString()})]}),e.jsxs("span",{className:"metric secondary",children:["/失败 ",e.jsx("strong",{className:c>0?"danger":"",children:c.toLocaleString()})]})]}),x.showHealth&&e.jsxs("div",{className:"metrics-row health",children:[e.jsx("span",{className:"row-label",children:"探活"}),e.jsx("span",{className:`metric health-${b}`,children:e.jsx("strong",{children:j[b]})}),e.jsx("span",{className:"sep",children:"|"}),e.jsx("span",{className:"metric",children:e.jsxs("strong",{children:[N||"--","ms"]})}),e.jsxs("span",{className:"metric secondary",children:["(",y,")"]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric secondary",children:["检查于 ",k]})]})]}),e.jsx(X,{nodeId:t.id,refreshKey:n,latest:l,shareToken:m}),e.jsx("div",{className:"node-card__footer",children:e.jsxs("div",{className:"node-card__badges",children:[t.circuit_open&&e.jsx("span",{className:"badge badge-warning",children:"熔断中"}),t.is_active&&!t.circuit_open&&e.jsx("span",{className:"badge badge-primary",children:"使用中"}),t.disabled&&e.jsx("span",{className:"badge badge-muted",children:"已停用"})]})})]})}function te(t,n){const[l,m]=s.useState(!1),[x,w]=s.useState(null),a=s.useRef(null),f=s.useRef(null),c=s.useRef(0),o=s.useRef(!0),j=s.useRef(()=>{}),v=s.useCallback(()=>{if(!o.current)return;f.current&&clearTimeout(f.current);const y=c.current,_=Math.min(3e4,1e3*2**y),i=_*.3*Math.random(),u=_+i;f.current=setTimeout(()=>{c.current+=1,j.current()},u)},[]),b=s.useCallback(()=>{const y=window.location.protocol==="https:"?"wss:":"ws:",N=window.location.host,k=new URLSearchParams;t&&k.set("account_id",t),n&&k.set("token",n);const _=k.toString(),i=`${y}//${N}/api/monitor/ws${_?`?${_}`:""}`;try{a.current&&a.current.close();const u=new WebSocket(i);u.onopen=()=>{c.current=0,m(!0)},u.onmessage=R=>{try{const C=JSON.parse(R.data);w(C)}catch(C){console.error("[WS] Failed to parse message:",C)}},u.onerror=R=>{console.error("[WS] Error:",R)},u.onclose=()=>{m(!1),a.current=null,v()},a.current=u}catch(u){console.error("[WS] Failed to connect:",u),v()}},[t,v,n]);return s.useEffect(()=>{j.current=b},[b]),s.useEffect(()=>(o.current=!0,b(),()=>{o.current=!1,f.current&&clearTimeout(f.current),a.current&&a.current.close()}),[b]),{connected:l,lastMessage:x}}export{ee as N,te as u};
