import{r,j as e,m as P}from"./vendor-HVpYYIdB.js";import{r as U,d as z}from"./index-cFc9t1GX.js";import{p as D,f as H}from"./date-DeDlRUHn.js";const q={"24h":1440*60*1e3,"7d":10080*60*1e3,"30d":720*60*60*1e3},B=60*1e3,W=new Map,T=new Map;function G(s,n,a,h){return[s,n,a||"",h||"scheduled"].join("__")}async function J(s,n,a,h,g){const o=new Date,l=o.toISOString(),m=new Date(o.getTime()-q[n]).toISOString(),c=new URLSearchParams;c.set("from",m),c.set("to",l),a&&c.set("share_token",a),h&&c.set("source",h);const i=c.toString(),f=i?`/api/nodes/${encodeURIComponent(s)}/health-history?${i}`:`/api/nodes/${encodeURIComponent(s)}/health-history`;return U(f,{signal:g})}function K(s,n){return{node_id:n.node_id||s,check_time:n.check_time,success:n.success,response_time_ms:typeof n.response_time_ms=="number"?n.response_time_ms:0,error_message:n.error_message||"",check_method:n.check_method||"api"}}function V({nodeId:s,refreshKey:n=0,latest:a,shareToken:h,source:g="scheduled"}){const[o,l]=r.useState("24h"),[m,c]=r.useState(null),[i,f]=r.useState(!1),[k,j]=r.useState(null),[R,y]=r.useState(null),N=r.useRef(null),w=r.useRef(n),p=r.useRef(!0),_=r.useMemo(()=>G(s,o,h,g),[s,o,h,g]),C=r.useCallback(async(t=!1)=>{const u=Date.now(),v=t?void 0:W.get(_);if(v&&u-v.ts<B){c(v.data),f(!1);return}if(!t){const d=T.get(_);if(d){f(!0);try{const $=await d.promise;if(!p.current||d.controller.signal.aborted)return;c($)}catch($){if(d.controller.signal.aborted)return;j($.message||"加载失败")}finally{d.controller.signal.aborted||f(!1)}return}}N.current&&N.current.abort();const x=new AbortController;N.current=x,f(!0),j(null);const E=J(s,o,h,g,x.signal).then(d=>(W.set(_,{data:d,ts:Date.now()}),d)).finally(()=>{T.get(_)?.controller===x&&T.delete(_)});T.set(_,{controller:x,promise:E});try{const d=await E;!x.signal.aborted&&p.current&&c(d)}catch(d){if(x.signal.aborted)return;j(d.message||"加载失败")}finally{x.signal.aborted||f(!1)}},[_,s,o,h,g]);r.useEffect(()=>(p.current=!0,()=>{p.current=!1,N.current&&N.current.abort()}),[]),r.useEffect(()=>{const t=n!==w.current;w.current=n,C(t)},[C,n]),r.useEffect(()=>{!a||a.node_id!==s||c(t=>{if(!t)return t;const u=K(s,a),v=D(u.check_time)?.getTime()||Date.now(),x=Date.now()-q[o];if(t.checks.some(L=>L.check_time===u.check_time))return t;const d=[...t.checks,u];d.sort((L,A)=>{const F=D(L.check_time)?.getTime()||0,O=D(A.check_time)?.getTime()||0;return F-O});const $=d.filter(L=>(D(L.check_time)?.getTime()||0)>=x);return{...t,to:new Date(Math.max(D(t.to)?.getTime()||0,v)).toISOString(),total:t.total+1,checks:$}})},[a,s,o]);const S=r.useMemo(()=>(m?.checks||[]).reduce((u,v)=>(v.success?u.ok+=1:u.fail+=1,u),{ok:0,fail:0}),[m]),M=()=>{if(!R)return null;const{rec:t,x:u,y:v}=R,x=t.success?"在线":"离线",E=e.jsxs("div",{className:"health-tooltip",style:{left:u+12,top:v-10},children:[e.jsx("div",{className:"health-tooltip__time",children:H(t.check_time)}),e.jsxs("div",{className:"health-tooltip__row",children:["状态：",x]}),e.jsxs("div",{className:"health-tooltip__row",children:["耗时：",t.response_time_ms||0," ms"]}),e.jsxs("div",{className:"health-tooltip__row",children:["方式：",t.check_method||"api"]}),t.error_message&&e.jsxs("div",{className:"health-tooltip__row",children:["错误：",t.error_message]})]});return typeof document>"u"?E:P.createPortal(E,document.body)},b=m?.checks||[];return e.jsxs("div",{className:"health-timeline",children:[e.jsxs("div",{className:"health-timeline__header",children:[e.jsxs("div",{className:"health-timeline__left",children:[e.jsx("span",{className:"health-timeline__title",children:"健康检查"}),e.jsx("div",{className:"health-timeline__chips",children:["24h","7d","30d"].map(t=>e.jsx("button",{type:"button",className:`chip ${o===t?"active":""}`,onClick:()=>l(t),children:t},t))})]}),e.jsxs("div",{className:"health-timeline__stats",children:[e.jsxs("span",{className:"pill ok",children:["在线 ",S.ok]}),e.jsxs("span",{className:"pill fail",children:["离线 ",S.fail]})]})]}),e.jsxs("div",{className:`health-track ${i?"loading":""}`,children:[i&&e.jsx("div",{className:"health-track__skeleton"}),!i&&b.length===0&&e.jsx("div",{className:"health-empty",children:"暂无数据"}),!i&&b.map((t,u)=>{const v=t.success?"ok":"fail";return e.jsx("div",{className:`health-dot ${v}`,onMouseEnter:x=>y({rec:t,x:x.clientX,y:x.clientY}),onMouseLeave:()=>y(null),title:H(t.check_time)},`${t.check_time}-${u}`)})]}),k&&e.jsx("div",{className:"health-error",children:k}),M()]})}function X({content:s,children:n,trigger:a="both",maxWidth:h="300px",position:g="top"}){const[o,l]=r.useState(!1),[m,c]=r.useState(!1),i=r.useRef(null),f=a==="hover"||a==="both",k=a==="click"||a==="both";if(!(s!=null&&s!==!1&&!(typeof s=="string"&&s.trim()==="")))return e.jsx(e.Fragment,{children:n});const R=()=>{f&&l(!0)},y=()=>{f&&(m||l(!1))},N=()=>{k&&l(p=>{const _=!p;return c(_),_})};r.useEffect(()=>{if(!o)return;const p=_=>{i.current&&(i.current.contains(_.target)||(l(!1),c(!1)))};return document.addEventListener("mousedown",p),document.addEventListener("touchstart",p),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("touchstart",p)}},[o]);const w=`tooltip-${g}`;return e.jsxs("div",{className:"tooltip-wrapper",ref:i,onMouseEnter:R,onMouseLeave:y,onClick:N,children:[n,e.jsxs("div",{className:`tooltip-content ${w} ${o?"show":""}`,style:{maxWidth:h},role:"tooltip",children:[s,e.jsx("span",{className:"tooltip-arrow"})]})]})}function I({node:s,historyRefreshKey:n,healthEvent:a,shareToken:h}){const{preference:g}=z(),o=Number(s.traffic?.success_rate??0),l=Number(s.traffic?.avg_response_time??0),m=Number(s.traffic?.total_requests??0),c=Number(s.traffic?.failed_requests??0),i=(s.last_error||s.health?.last_ping_err||"").trim(),f={up:"在线",down:"离线"},j=(s.health?.status||"down")==="up"?"up":"down",R=(s.health?.check_method||"api").toUpperCase(),y=Number(s.health?.last_ping_ms??0),N=s.health?.last_check_at?s.health.last_check_at.replace(/^\d{4}年\d{2}月\d{2}日\s*/,""):"--",w=s.circuit_open?"node-card node-card--circuit-open":s.is_active?"node-card node-card--active":"node-card";return e.jsxs("div",{className:w,children:[i&&e.jsx("div",{className:"node-card__error-badge",children:e.jsx(X,{content:i,trigger:"both",maxWidth:"300px",children:e.jsx("span",{className:"node-card__error-icon",role:"img","aria-label":"错误",children:"⚠️"})})}),e.jsx("div",{className:"node-card__header",children:e.jsxs("div",{className:"node-card__title-wrap",children:[e.jsx("div",{className:"node-card__title",children:s.name||"未命名节点"}),e.jsx("div",{className:"node-card__url",children:s.url||"-"})]})}),e.jsxs("div",{className:"node-card__metrics-compact",children:[g.showProxy&&e.jsxs("div",{className:"metrics-row traffic",children:[e.jsx("span",{className:"row-label",children:"代理"}),e.jsxs("span",{className:"metric",children:["成功率 ",e.jsxs("strong",{children:[o.toFixed(1),"%"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["延时 ",e.jsxs("strong",{children:[l||"--","ms"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["请求 ",e.jsx("strong",{children:m.toLocaleString()})]}),e.jsxs("span",{className:"metric secondary",children:["/失败 ",e.jsx("strong",{className:c>0?"danger":"",children:c.toLocaleString()})]})]}),g.showHealth&&e.jsxs("div",{className:"metrics-row health",children:[e.jsx("span",{className:"row-label",children:"探活"}),e.jsx("span",{className:`metric health-${j}`,children:e.jsx("strong",{children:f[j]})}),e.jsx("span",{className:"sep",children:"|"}),e.jsx("span",{className:"metric",children:e.jsxs("strong",{children:[y||"--","ms"]})}),e.jsxs("span",{className:"metric secondary",children:["(",R,")"]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric secondary",children:["检查于 ",N]})]})]}),e.jsx(V,{nodeId:s.id,refreshKey:n,latest:a,shareToken:h}),e.jsx("div",{className:"node-card__footer",children:e.jsxs("div",{className:"node-card__badges",children:[s.circuit_open&&e.jsx("span",{className:"badge badge-warning",children:"熔断中"}),s.is_active&&!s.circuit_open&&e.jsx("span",{className:"badge badge-primary",children:"使用中"}),s.disabled&&e.jsx("span",{className:"badge badge-muted",children:"已停用"})]})})]})}function ee(s,n){const[a,h]=r.useState(!1),[g,o]=r.useState(null),l=r.useRef(null),m=r.useRef(null),c=r.useRef(0),i=r.useRef(!0),f=r.useRef(()=>{}),k=r.useRef(null),j=r.useRef(null),R=r.useCallback(()=>{k.current&&(o(k.current),k.current=null),j.current=null},[]),y=r.useCallback(()=>{j.current===null&&(j.current=window.requestAnimationFrame(R))},[R]),N=r.useCallback(()=>{if(!i.current)return;m.current&&clearTimeout(m.current);const p=c.current,S=Math.min(3e4,1e3*2**p),M=S*.3*Math.random(),b=S+M;m.current=setTimeout(()=>{c.current+=1,f.current()},b)},[]),w=r.useCallback(()=>{const p=window.location.protocol==="https:"?"wss:":"ws:",_=window.location.host,C=new URLSearchParams;s&&C.set("account_id",s),n&&C.set("token",n);const S=C.toString(),M=`${p}//${_}/api/monitor/ws${S?`?${S}`:""}`;try{l.current&&l.current.close();const b=new WebSocket(M);b.onopen=()=>{c.current=0,h(!0)},b.onmessage=t=>{try{const u=JSON.parse(t.data);k.current=u,y()}catch(u){console.error("[WS] Failed to parse message:",u)}},b.onerror=t=>{console.error("[WS] Error:",t)},b.onclose=()=>{h(!1),l.current=null,N()},l.current=b}catch(b){console.error("[WS] Failed to connect:",b),N()}},[s,y,N,n]);return r.useEffect(()=>{f.current=w},[w]),r.useEffect(()=>(i.current=!0,w(),()=>{i.current=!1,m.current&&clearTimeout(m.current),j.current!==null&&cancelAnimationFrame(j.current),l.current&&l.current.close()}),[w]),{connected:a,lastMessage:g}}export{I as N,ee as u};
