import{r as s,j as e,m as B}from"./vendor-HVpYYIdB.js";import{r as G,d as J}from"./index-DHDrpoUu.js";import{p as H,f as q}from"./date-DeDlRUHn.js";const O={"24h":1440*60*1e3,"7d":10080*60*1e3,"30d":720*60*60*1e3},K=60*1e3,A=new Map,F=new Map;function V(t,r,o,h){return[t,r,o||"",h||"scheduled"].join("__")}async function X(t,r,o,h,g){const l=new Date,i=l.toISOString(),d=new Date(l.getTime()-O[r]).toISOString(),a=new URLSearchParams;a.set("from",d),a.set("to",i),o&&a.set("share_token",o),h&&a.set("source",h);const u=a.toString(),m=u?`/api/nodes/${encodeURIComponent(t)}/health-history?${u}`:`/api/nodes/${encodeURIComponent(t)}/health-history`;return G(m,{signal:g})}function Y(t,r){return{node_id:r.node_id||t,check_time:r.check_time,success:r.success,response_time_ms:typeof r.response_time_ms=="number"?r.response_time_ms:0,error_message:r.error_message||"",check_method:r.check_method||"api"}}function Q({nodeId:t,refreshKey:r=0,latest:o,shareToken:h,source:g="scheduled"}){const[l,i]=s.useState("24h"),[d,a]=s.useState(null),[u,m]=s.useState(!1),[v,_]=s.useState(null),[S,R]=s.useState(null),[c,C]=s.useState(!1),N=s.useCallback(()=>{c&&p.current&&(p.current.abort(),m(!1)),c||_(null),C(n=>!n)},[c]),p=s.useRef(null),E=s.useRef(r),y=s.useRef(!0),w=s.useMemo(()=>V(t,l,h,g),[t,l,h,g]),b=s.useCallback(async(n=!1)=>{if(!c)return;const j=Date.now(),k=n?void 0:A.get(w);if(k&&j-k.ts<K){a(k.data),m(!1);return}if(!n){const f=F.get(w);if(f){m(!0);try{const T=await f.promise;if(!y.current||f.controller.signal.aborted)return;a(T)}catch(T){if(f.controller.signal.aborted)return;_(T.message||"加载失败")}finally{f.controller.signal.aborted||m(!1)}return}}p.current&&p.current.abort();const x=new AbortController;p.current=x,m(!0),_(null);const $=X(t,l,h,g,x.signal).then(f=>(A.set(w,{data:f,ts:Date.now()}),f)).finally(()=>{F.get(w)?.controller===x&&F.delete(w)});F.set(w,{controller:x,promise:$});try{const f=await $;!x.signal.aborted&&y.current&&a(f)}catch(f){if(x.signal.aborted)return;_(f.message||"加载失败")}finally{x.signal.aborted||m(!1)}},[w,c,t,l,h,g]);s.useEffect(()=>(y.current=!0,()=>{y.current=!1,p.current&&p.current.abort()}),[]),s.useEffect(()=>{if(!c)return;const n=r!==E.current;E.current=r,b(n)},[c,b,r]),s.useEffect(()=>{!c||!o||o.node_id!==t||a(n=>{if(!n)return n;const j=Y(t,o),k=H(j.check_time)?.getTime()||Date.now(),x=Date.now()-O[l];if(n.checks.some(D=>D.check_time===j.check_time))return n;const f=[...n.checks,j];f.sort((D,P)=>{const U=H(D.check_time)?.getTime()||0,z=H(P.check_time)?.getTime()||0;return U-z});const T=f.filter(D=>(H(D.check_time)?.getTime()||0)>=x);return{...n,to:new Date(Math.max(H(n.to)?.getTime()||0,k)).toISOString(),total:n.total+1,checks:T}})},[c,o,t,l]),s.useEffect(()=>{c||R(null)},[c]);const M=s.useMemo(()=>(d?.checks||[]).reduce((j,k)=>(k.success?j.ok+=1:j.fail+=1,j),{ok:0,fail:0}),[d]),L=()=>{if(!c||!S)return null;const{rec:n,x:j,y:k}=S,x=n.success?"在线":"离线",$=e.jsxs("div",{className:"health-tooltip",style:{left:j+12,top:k-10},children:[e.jsx("div",{className:"health-tooltip__time",children:q(n.check_time)}),e.jsxs("div",{className:"health-tooltip__row",children:["状态：",x]}),e.jsxs("div",{className:"health-tooltip__row",children:["耗时：",n.response_time_ms||0," ms"]}),e.jsxs("div",{className:"health-tooltip__row",children:["方式：",n.check_method||"api"]}),n.error_message&&e.jsxs("div",{className:"health-tooltip__row",children:["错误：",n.error_message]})]});return typeof document>"u"?$:B.createPortal($,document.body)},W=c&&d?d.checks||[]:[];return e.jsxs("div",{className:`health-timeline ${c?"":"health-timeline--collapsed"}`,children:[e.jsxs("div",{className:"health-timeline__header",children:[e.jsxs("div",{className:"health-timeline__left",children:[e.jsx("span",{className:"health-timeline__title",children:"健康检查"}),e.jsx("div",{className:"health-timeline__chips",children:["24h","7d","30d"].map(n=>e.jsx("button",{type:"button",className:`chip ${l===n?"active":""}`,onClick:()=>i(n),children:n},n))})]}),e.jsxs("div",{className:"health-timeline__stats",children:[e.jsxs("span",{className:"pill ok",children:["在线 ",M.ok]}),e.jsxs("span",{className:"pill fail",children:["离线 ",M.fail]}),e.jsx("button",{type:"button",className:"chip",onClick:N,children:c?"收起历史":"展开加载"})]})]}),c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`health-track ${u?"loading":""}`,children:[u&&e.jsx("div",{className:"health-track__skeleton"}),!u&&W.length===0&&e.jsx("div",{className:"health-empty",children:"暂无数据"}),!u&&W.map((n,j)=>{const k=n.success?"ok":"fail";return e.jsx("div",{className:`health-dot ${k}`,onMouseEnter:x=>R({rec:n,x:x.clientX,y:x.clientY}),onMouseLeave:()=>R(null),title:q(n.check_time)},`${n.check_time}-${j}`)})]}),v&&e.jsx("div",{className:"health-error",children:v}),L()]}):e.jsx("div",{className:"health-track collapsed-hint",children:"点击“展开加载”查看健康历史"})]})}function Z({content:t,children:r,trigger:o="both",maxWidth:h="300px",position:g="top"}){const[l,i]=s.useState(!1),[d,a]=s.useState(!1),u=s.useRef(null),m=o==="hover"||o==="both",v=o==="click"||o==="both";if(!(t!=null&&t!==!1&&!(typeof t=="string"&&t.trim()==="")))return e.jsx(e.Fragment,{children:r});const S=()=>{m&&i(!0)},R=()=>{m&&(d||i(!1))},c=()=>{v&&i(N=>{const p=!N;return a(p),p})};s.useEffect(()=>{if(!l)return;const N=p=>{u.current&&(u.current.contains(p.target)||(i(!1),a(!1)))};return document.addEventListener("mousedown",N),document.addEventListener("touchstart",N),()=>{document.removeEventListener("mousedown",N),document.removeEventListener("touchstart",N)}},[l]);const C=`tooltip-${g}`;return e.jsxs("div",{className:"tooltip-wrapper",ref:u,onMouseEnter:S,onMouseLeave:R,onClick:c,children:[r,e.jsxs("div",{className:`tooltip-content ${C} ${l?"show":""}`,style:{maxWidth:h},role:"tooltip",children:[t,e.jsx("span",{className:"tooltip-arrow"})]})]})}function se({node:t,historyRefreshKey:r,healthEvent:o,shareToken:h}){const{preference:g}=J(),l=Number(t.traffic?.success_rate??0),i=Number(t.traffic?.avg_response_time??0),d=Number(t.traffic?.total_requests??0),a=Number(t.traffic?.failed_requests??0),u=(t.last_error||t.health?.last_ping_err||"").trim(),m={up:"在线",down:"离线"},_=(t.health?.status||"down")==="up"?"up":"down",S=(t.health?.check_method||"api").toUpperCase(),R=Number(t.health?.last_ping_ms??0),c=t.health?.last_check_at?t.health.last_check_at.replace(/^\d{4}年\d{2}月\d{2}日\s*/,""):"--";return e.jsxs("div",{className:`node-card ${t.is_active?"node-card--active":""}`,children:[u&&e.jsx("div",{className:"node-card__error-badge",children:e.jsx(Z,{content:u,trigger:"both",maxWidth:"300px",children:e.jsx("span",{className:"node-card__error-icon",role:"img","aria-label":"错误",children:"⚠️"})})}),e.jsx("div",{className:"node-card__header",children:e.jsxs("div",{className:"node-card__title-wrap",children:[e.jsx("div",{className:"node-card__title",children:t.name||"未命名节点"}),e.jsx("div",{className:"node-card__url",children:t.url||"-"})]})}),e.jsxs("div",{className:"node-card__metrics-compact",children:[g.showProxy&&e.jsxs("div",{className:"metrics-row traffic",children:[e.jsx("span",{className:"row-label",children:"代理"}),e.jsxs("span",{className:"metric",children:["成功率 ",e.jsxs("strong",{children:[l.toFixed(1),"%"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["延时 ",e.jsxs("strong",{children:[i||"--","ms"]})]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric",children:["请求 ",e.jsx("strong",{children:d.toLocaleString()})]}),e.jsxs("span",{className:"metric secondary",children:["/失败 ",e.jsx("strong",{className:a>0?"danger":"",children:a.toLocaleString()})]})]}),g.showHealth&&e.jsxs("div",{className:"metrics-row health",children:[e.jsx("span",{className:"row-label",children:"探活"}),e.jsx("span",{className:`metric health-${_}`,children:e.jsx("strong",{children:m[_]})}),e.jsx("span",{className:"sep",children:"|"}),e.jsx("span",{className:"metric",children:e.jsxs("strong",{children:[R||"--","ms"]})}),e.jsxs("span",{className:"metric secondary",children:["(",S,")"]}),e.jsx("span",{className:"sep",children:"|"}),e.jsxs("span",{className:"metric secondary",children:["检查于 ",c]})]})]}),e.jsx(Q,{nodeId:t.id,refreshKey:r,latest:o,shareToken:h}),e.jsx("div",{className:"node-card__footer",children:e.jsx("div",{className:"node-card__badges",children:t.disabled&&e.jsx("span",{className:"badge badge-muted",children:"已停用"})})})]})}function ne(t,r){const[o,h]=s.useState(!1),[g,l]=s.useState(null),i=s.useRef(null),d=s.useRef(null),a=s.useRef(0),u=s.useRef(!0),m=s.useRef(()=>{}),v=s.useRef(null),_=s.useRef(null),S=s.useCallback(()=>{v.current&&(l(v.current),v.current=null),_.current=null},[]),R=s.useCallback(()=>{_.current===null&&(_.current=window.requestAnimationFrame(S))},[S]),c=s.useCallback(()=>{if(!u.current)return;d.current&&clearTimeout(d.current);const N=a.current,y=Math.min(3e4,1e3*2**N),w=y*.3*Math.random(),b=y+w;d.current=setTimeout(()=>{a.current+=1,m.current()},b)},[]),C=s.useCallback(()=>{const N=window.location.protocol==="https:"?"wss:":"ws:",p=window.location.host,E=new URLSearchParams;t&&E.set("account_id",t),r&&E.set("token",r);const y=E.toString(),w=`${N}//${p}/api/monitor/ws${y?`?${y}`:""}`;try{i.current&&i.current.close();const b=new WebSocket(w);b.onopen=()=>{a.current=0,h(!0)},b.onmessage=M=>{try{const L=JSON.parse(M.data);v.current=L,R()}catch(L){console.error("[WS] Failed to parse message:",L)}},b.onerror=M=>{console.error("[WS] Error:",M)},b.onclose=()=>{h(!1),i.current=null,c()},i.current=b}catch(b){console.error("[WS] Failed to connect:",b),c()}},[t,R,c,r]);return s.useEffect(()=>{m.current=C},[C]),s.useEffect(()=>(u.current=!0,C(),()=>{u.current=!1,d.current&&clearTimeout(d.current),_.current!==null&&cancelAnimationFrame(_.current),i.current&&i.current.close()}),[C]),{connected:o,lastMessage:g}}export{se as N,ne as u};
